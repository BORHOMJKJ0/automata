{
    "sourceFile": "app/Services/Dropbox/DropboxApiService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766740568788,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766740879959,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,239 @@\n-<?php\n\\ No newline at end of file\n+<?php\n+namespace App\\Services\\Dropbox;\n+\n+use Illuminate\\Support\\Facades\\Http;\n+use Illuminate\\Support\\Facades\\Log;\n+\n+class DropboxApiService\n+{\n+    public function getSharedLinkMetadata(string $accessToken, string $sharedUrl): ?array\n+    {\n+        try {\n+            $response = Http::withHeaders([\n+                'Authorization' => 'Bearer ' . $accessToken,\n+                'Content-Type' => 'application/json',\n+            ])->post('https://api.dropboxapi.com/2/sharing/get_shared_link_metadata', [\n+                'url' => $sharedUrl,\n+            ]);\n+\n+            return $response->successful() ? $response->json() : null;\n+        } catch (\\Exception $e) {\n+            Log::error('Metadata Error: ' . $e->getMessage());\n+            return null;\n+        }\n+    }\n+\n+    public function listFolderContents(string $accessToken, string $sharedUrl, string $path): array\n+    {\n+        try {\n+            $response = Http::withHeaders([\n+                'Authorization' => 'Bearer ' . $accessToken,\n+                'Content-Type' => 'application/json',\n+            ])->post('https://api.dropboxapi.com/2/files/list_folder', [\n+                'path' => $path,\n+                'shared_link' => ['url' => $sharedUrl],\n+            ]);\n+\n+            if ($response->failed()) {\n+                throw new \\Exception('Failed to list folder');\n+            }\n+\n+            $data = $response->json();\n+            return $this->organizeItems($data['entries'] ?? []);\n+        } catch (\\Exception $e) {\n+            Log::error('List Folder Error: ' . $e->getMessage());\n+            throw $e;\n+        }\n+    }\n+\n+    public function getAllFilesRecursive(string $accessToken, string $sharedUrl, ?string $path = '', ?string $cursor = null): array\n+    {\n+        $allEntries = [];\n+        $path = $path ?? '';\n+\n+        try {\n+            if ($cursor) {\n+                $response = Http::withHeaders([\n+                    'Authorization' => 'Bearer ' . $accessToken,\n+                    'Content-Type' => 'application/json',\n+                ])->post('https://api.dropboxapi.com/2/files/list_folder/continue', [\n+                    'cursor' => $cursor,\n+                ]);\n+            } else {\n+                $response = Http::withHeaders([\n+                    'Authorization' => 'Bearer ' . $accessToken,\n+                    'Content-Type' => 'application/json',\n+                ])->post('https://api.dropboxapi.com/2/files/list_folder', [\n+                    'path' => $path,\n+                    'shared_link' => ['url' => $sharedUrl],\n+                    'recursive' => false,\n+                    'limit' => 2000,\n+                ]);\n+            }\n+\n+            if ($response->successful()) {\n+                $data = $response->json();\n+                $entries = $data['entries'] ?? [];\n+\n+                foreach ($entries as $entry) {\n+                    $allEntries[] = $entry;\n+\n+                    if ($entry['.tag'] === 'folder') {\n+                        $folderPath = $entry['path_display'] ?? $entry['path_lower'];\n+                        if ($folderPath) {\n+                            $subEntries = $this->getAllFilesRecursive($accessToken, $sharedUrl, $folderPath);\n+                            $allEntries = array_merge($allEntries, $subEntries);\n+                        }\n+                    }\n+                }\n+\n+                if (($data['has_more'] ?? false) && isset($data['cursor'])) {\n+                    $moreEntries = $this->getAllFilesRecursive($accessToken, $sharedUrl, $path, $data['cursor']);\n+                    $allEntries = array_merge($allEntries, $moreEntries);\n+                }\n+            }\n+        } catch (\\Exception $e) {\n+            Log::error('Recursive List Error: ' . $e->getMessage());\n+        }\n+\n+        return $allEntries;\n+    }\n+\n+    public function downloadFileContent(string $accessToken, string $sharedUrl, string $path): ?string\n+    {\n+        try {\n+            Log::info(\"=== Attempting Download ===\");\n+            Log::info(\"Original path: {$path}\");\n+\n+            $metadata = $this->getSharedLinkMetadata($accessToken, $sharedUrl);\n+\n+            if (!$metadata) {\n+                Log::error(\"Could not get shared link metadata\");\n+                return null;\n+            }\n+\n+            $sharedLinkPath = $metadata['path_lower'] ?? '';\n+            $relativePath = $path;\n+\n+            if (!empty($sharedLinkPath) && strpos($path, $sharedLinkPath) === 0) {\n+                $relativePath = substr($path, strlen($sharedLinkPath));\n+            }\n+\n+            if (empty($relativePath)) {\n+                $relativePath = '/';\n+            } elseif (strpos($relativePath, '/') !== 0) {\n+                $relativePath = '/' . $relativePath;\n+            }\n+\n+            $response = Http::timeout(60)\n+                ->withHeaders([\n+                    'Authorization' => 'Bearer ' . $accessToken,\n+                    'Dropbox-API-Arg' => json_encode([\n+                        'url' => $sharedUrl,\n+                        'path' => $relativePath,\n+                    ]),\n+                ])\n+                ->withBody('', 'application/octet-stream')\n+                ->post('https://content.dropboxapi.com/2/sharing/get_shared_link_file');\n+\n+            if ($response->successful()) {\n+                Log::info(\"✓ Download successful! Size: \" . strlen($response->body()) . \" bytes\");\n+                return $response->body();\n+            }\n+\n+            Log::error(\"✗ Download failed! Status: \" . $response->status());\n+            return null;\n+\n+        } catch (\\Exception $e) {\n+            Log::error(\"Download exception: \" . $e->getMessage());\n+            return null;\n+        }\n+    }\n+\n+    public function uploadFile(string $accessToken, string $path, string $content, bool $overwrite = false): bool\n+    {\n+        try {\n+            Log::info(\"=== Starting Upload ===\");\n+            Log::info(\"Path: {$path}\");\n+\n+            $normalizedPath = (strpos($path, '/') !== 0) ? '/' . $path : $path;\n+            $mode = $overwrite ? 'overwrite' : 'add';\n+\n+            $response = Http::timeout(120)\n+                ->withHeaders([\n+                    'Authorization' => 'Bearer ' . $accessToken,\n+                    'Dropbox-API-Arg' => json_encode([\n+                        'path' => $normalizedPath,\n+                        'mode' => $mode,\n+                        'autorename' => !$overwrite,\n+                        'mute' => false,\n+                    ]),\n+                    'Content-Type' => 'application/octet-stream',\n+                ])\n+                ->withBody($content, 'application/octet-stream')\n+                ->post('https://content.dropboxapi.com/2/files/upload');\n+\n+            if ($response->successful()) {\n+                Log::info(\"✓ File uploaded successfully!\");\n+                return true;\n+            }\n+\n+            Log::error('✗ Upload failed! Status: ' . $response->status());\n+            return false;\n+\n+        } catch (\\Exception $e) {\n+            Log::error('Upload Exception: ' . $e->getMessage());\n+            return false;\n+        }\n+    }\n+\n+    private function organizeItems(array $entries): array\n+    {\n+        $items = ['folders' => [], 'files' => []];\n+\n+        foreach ($entries as $entry) {\n+            $path = $entry['path_display'] ?? $entry['path_lower'] ?? null;\n+            if (!$path) {\n+                continue;\n+            }\n+\n+            if ($entry['.tag'] === 'folder') {\n+                $items['folders'][] = [\n+                    'name' => $entry['name'] ?? basename($path),\n+                    'path' => $path,\n+                ];\n+            } elseif ($entry['.tag'] === 'file') {\n+                $fileName = $entry['name'] ?? basename($path);\n+                $extension = pathinfo($fileName, PATHINFO_EXTENSION);\n+\n+                $items['files'][] = [\n+                    'name' => $fileName,\n+                    'path' => $path,\n+                    'size' => $entry['size'] ?? 0,\n+                    'modified' => $entry['server_modified'] ?? null,\n+                    'extension' => strtolower($extension),\n+                    'is_editable' => $this->isEditable($extension),\n+                    'is_previewable' => $this->isPreviewable($extension),\n+                ];\n+            }\n+        }\n+\n+        return $items;\n+    }\n+\n+    private function isEditable(string $extension): bool\n+    {\n+        $editable = ['txt', 'md', 'json', 'xml', 'html', 'css', 'js', 'php', 'py', 'java'];\n+        return in_array(strtolower($extension), $editable);\n+    }\n+\n+    private function isPreviewable(string $extension): bool\n+    {\n+        $previewable = [\n+            'txt', 'md', 'json', 'xml', 'html', 'css', 'js',\n+            'php', 'py', 'java', 'c', 'cpp', 'h', 'yml', 'yaml',\n+            'ini', 'conf', 'log', 'sql', 'sh', 'bat',\n+        ];\n+        return in_array(strtolower($extension), $previewable);\n+    }\n+}\n"
                }
            ],
            "date": 1766740568788,
            "name": "Commit-0",
            "content": "<?php\n"
        }
    ]
}