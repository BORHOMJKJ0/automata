{
    "sourceFile": "app/Services/Excel/ExcelProcessorService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1766740566119,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766740970182,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,228 @@\n-<?php\n\\ No newline at end of file\n+<?php\n+namespace App\\Services\\Excel;\n+\n+use Illuminate\\Support\\Facades\\Log;\n+use PhpOffice\\PhpSpreadsheet\\IOFactory;\n+use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n+use App\\Services\\Dropbox\\DropboxApiService;\n+use App\\Services\\Pdf\\PdfParserService;\n+\n+class ExcelProcessorService\n+{\n+    private DropboxApiService $dropboxApi;\n+    private PdfParserService $pdfParser;\n+\n+    public function __construct(DropboxApiService $dropboxApi, PdfParserService $pdfParser)\n+    {\n+        $this->dropboxApi = $dropboxApi;\n+        $this->pdfParser = $pdfParser;\n+    }\n+\n+    public function processExcelWithPdfs(\n+        string $accessToken,\n+        string $sharedUrl,\n+        string $excelPath,\n+        array $matchingFiles\n+    ): array {\n+        $excelContent = $this->dropboxApi->downloadFileContent($accessToken, $sharedUrl, $excelPath);\n+\n+        if (!$excelContent) {\n+            throw new \\Exception('Failed to download Excel file');\n+        }\n+\n+        $tempExcelPath = tempnam(sys_get_temp_dir(), 'excel_') . '.xlsx';\n+        file_put_contents($tempExcelPath, $excelContent);\n+\n+        $spreadsheet = IOFactory::load($tempExcelPath);\n+        $worksheet = $spreadsheet->getActiveSheet();\n+\n+        $updatedCount = 0;\n+        $processedFiles = [];\n+\n+        foreach ($matchingFiles as $file) {\n+            if (!str_ends_with(strtolower($file['name']), '.pdf')) {\n+                continue;\n+            }\n+\n+            $pdfContent = $this->dropboxApi->downloadFileContent($accessToken, $sharedUrl, $file['path']);\n+\n+            if (!$pdfContent) {\n+                $processedFiles[] = [\n+                    'name' => $file['name'],\n+                    'status' => 'error',\n+                    'message' => 'Failed to download PDF',\n+                ];\n+                continue;\n+            }\n+\n+            $pdfData = $this->pdfParser->extractPdfData($pdfContent);\n+\n+            if ($pdfData && $pdfData['manifest_number'] !== 'Not Found') {\n+                $updated = $this->updateExcelRow($worksheet, $pdfData);\n+\n+                if ($updated) {\n+                    $updatedCount++;\n+                    $processedFiles[] = [\n+                        'name' => $file['name'],\n+                        'status' => 'success',\n+                        'manifest' => $pdfData['manifest_number'],\n+                    ];\n+                }\n+            } else {\n+                $processedFiles[] = [\n+                    'name' => $file['name'],\n+                    'status' => 'warning',\n+                    'message' => 'No valid data found',\n+                ];\n+            }\n+        }\n+\n+        $writer = new Xlsx($spreadsheet);\n+        $writer->save($tempExcelPath);\n+        $updatedContent = file_get_contents($tempExcelPath);\n+        unlink($tempExcelPath);\n+\n+        $uploaded = $this->dropboxApi->uploadFile($accessToken, $excelPath, $updatedContent, true);\n+\n+        return [\n+            'success' => $uploaded,\n+            'updatedCount' => $updatedCount,\n+            'processedFiles' => $processedFiles,\n+        ];\n+    }\n+\n+    private function updateExcelRow($worksheet, array $pdfData): bool\n+    {\n+        try {\n+            $highestRow = $worksheet->getHighestRow();\n+            $manifestNumber = trim($pdfData['manifest_number']);\n+\n+            // Check for duplicates\n+            for ($row = 2; $row <= $highestRow; $row++) {\n+                $cellValue = trim((string) $worksheet->getCell(\"A{$row}\")->getValue());\n+                if ($cellValue == $manifestNumber) {\n+                    Log::info(\"⚠️ Manifest {$manifestNumber} already exists - SKIPPING\");\n+                    return false;\n+                }\n+            }\n+\n+            // Add new row\n+            $newRow = $highestRow + 1;\n+\n+            $worksheet->setCellValue(\"A{$newRow}\", $pdfData['manifest_number']);\n+            $worksheet->setCellValue(\"B{$newRow}\", $pdfData['manifest_date']);\n+            $worksheet->setCellValue(\"C{$newRow}\", $pdfData['waste_description']);\n+            $worksheet->setCellValue(\"D{$newRow}\", $pdfData['wastes_location']);\n+            $worksheet->setCellValue(\"E{$newRow}\", $pdfData['recycled_plastic']);\n+            $worksheet->setCellValue(\"F{$newRow}\", $pdfData['recycled_paper']);\n+            $worksheet->setCellValue(\"G{$newRow}\", $pdfData['recycled_wood']);\n+            $worksheet->setCellValue(\"H{$newRow}\", $pdfData['recycled_steel']);\n+\n+            Log::info(\"✓ Row {$newRow} added successfully\");\n+            return true;\n+        } catch (\\Exception $e) {\n+            Log::error('Excel Update Error: ' . $e->getMessage());\n+            return false;\n+        }\n+    }\n+}\n+\n+// ==================== 4. PdfParserService.php ====================\n+namespace App\\Services\\Pdf;\n+\n+use Illuminate\\Support\\Facades\\Log;\n+use Smalot\\PdfParser\\Parser as PdfParser;\n+\n+class PdfParserService\n+{\n+    public function extractText(string $pdfContent): ?string\n+    {\n+        try {\n+            $tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n+            file_put_contents($tempPdfPath, $pdfContent);\n+\n+            $parser = new PdfParser;\n+            $pdf = $parser->parseFile($tempPdfPath);\n+            $text = $pdf->getText();\n+            unlink($tempPdfPath);\n+\n+            return $text;\n+        } catch (\\Exception $e) {\n+            Log::error('PDF Parse Error: ' . $e->getMessage());\n+            return null;\n+        }\n+    }\n+\n+    public function extractPdfData(string $pdfContent): ?array\n+    {\n+        $text = $this->extractText($pdfContent);\n+\n+        if (!$text || strlen($text) < 50) {\n+            return null;\n+        }\n+\n+        $data = [\n+            'manifest_number' => $this->extractValue($text, 'Manifest Number'),\n+            'manifest_date' => $this->extractValue($text, 'Manifest Date'),\n+            'wastes_location' => $this->extractValue($text, 'Wastes Location'),\n+            'waste_description' => $this->extractWasteFromPart3($text),\n+            'quantity' => $this->extractQuantityFromPart3($text),\n+        ];\n+\n+        $wasteDesc = strtolower($data['waste_description']);\n+        $data['recycled_plastic'] = (strpos($wasteDesc, 'plastic') !== false) ? $data['quantity'] : 0;\n+        $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ? $data['quantity'] : 0;\n+        $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $data['quantity'] : 0;\n+        $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false) ? $data['quantity'] : 0;\n+\n+        return $data;\n+    }\n+\n+    public function extractValue(string $content, string $fieldName): string\n+    {\n+        $content = preg_replace('/^\\xEF\\xBB\\xBF/', '', $content);\n+        $content = preg_replace('/\\r\\n/', \"\\n\", $content);\n+\n+        if ($fieldName === 'Producer Name') {\n+            if (preg_match('/Producer\\s+Name\\s*:\\s*\\n\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade License|Mobile|Email|Company Name|Part \\d+|$))/is', $content, $matches)) {\n+                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+            }\n+        }\n+\n+        if ($fieldName === 'Wastes Location') {\n+            if (preg_match('/Wastes?\\s+Location\\s*:\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n+                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+            }\n+        }\n+\n+        if ($fieldName === 'Manifest Number') {\n+            if (preg_match('/Manifest\\s+Number\\s*:\\s*([0-9]+)/i', $content, $matches)) {\n+                return trim($matches[1]);\n+            }\n+        }\n+\n+        if ($fieldName === 'Manifest Date') {\n+            if (preg_match('/Manifest\\s+Date\\s*:\\s*([0-9\\/\\-]+)/i', $content, $matches)) {\n+                return trim($matches[1]);\n+            }\n+        }\n+\n+        return 'Not Found';\n+    }\n+\n+    private function extractWasteFromPart3(string $text): string\n+    {\n+        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n\\s*([^\\n]+)/is', $text, $matches)) {\n+            return trim($matches[1]);\n+        }\n+        return 'Not Found';\n+    }\n+\n+    private function extractQuantityFromPart3(string $text): int\n+    {\n+        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n[^\\d]*(\\d+)/is', $text, $matches)) {\n+            return (int) $matches[1];\n+        }\n+        return 0;\n+    }\n+}\n"
                },
                {
                    "date": 1766740994094,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,105 +125,4 @@\n             return false;\n         }\n     }\n }\n-\n-// ==================== 4. PdfParserService.php ====================\n-namespace App\\Services\\Pdf;\n-\n-use Illuminate\\Support\\Facades\\Log;\n-use Smalot\\PdfParser\\Parser as PdfParser;\n-\n-class PdfParserService\n-{\n-    public function extractText(string $pdfContent): ?string\n-    {\n-        try {\n-            $tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n-            file_put_contents($tempPdfPath, $pdfContent);\n-\n-            $parser = new PdfParser;\n-            $pdf = $parser->parseFile($tempPdfPath);\n-            $text = $pdf->getText();\n-            unlink($tempPdfPath);\n-\n-            return $text;\n-        } catch (\\Exception $e) {\n-            Log::error('PDF Parse Error: ' . $e->getMessage());\n-            return null;\n-        }\n-    }\n-\n-    public function extractPdfData(string $pdfContent): ?array\n-    {\n-        $text = $this->extractText($pdfContent);\n-\n-        if (!$text || strlen($text) < 50) {\n-            return null;\n-        }\n-\n-        $data = [\n-            'manifest_number' => $this->extractValue($text, 'Manifest Number'),\n-            'manifest_date' => $this->extractValue($text, 'Manifest Date'),\n-            'wastes_location' => $this->extractValue($text, 'Wastes Location'),\n-            'waste_description' => $this->extractWasteFromPart3($text),\n-            'quantity' => $this->extractQuantityFromPart3($text),\n-        ];\n-\n-        $wasteDesc = strtolower($data['waste_description']);\n-        $data['recycled_plastic'] = (strpos($wasteDesc, 'plastic') !== false) ? $data['quantity'] : 0;\n-        $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ? $data['quantity'] : 0;\n-        $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $data['quantity'] : 0;\n-        $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false) ? $data['quantity'] : 0;\n-\n-        return $data;\n-    }\n-\n-    public function extractValue(string $content, string $fieldName): string\n-    {\n-        $content = preg_replace('/^\\xEF\\xBB\\xBF/', '', $content);\n-        $content = preg_replace('/\\r\\n/', \"\\n\", $content);\n-\n-        if ($fieldName === 'Producer Name') {\n-            if (preg_match('/Producer\\s+Name\\s*:\\s*\\n\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade License|Mobile|Email|Company Name|Part \\d+|$))/is', $content, $matches)) {\n-                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-            }\n-        }\n-\n-        if ($fieldName === 'Wastes Location') {\n-            if (preg_match('/Wastes?\\s+Location\\s*:\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n-                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-            }\n-        }\n-\n-        if ($fieldName === 'Manifest Number') {\n-            if (preg_match('/Manifest\\s+Number\\s*:\\s*([0-9]+)/i', $content, $matches)) {\n-                return trim($matches[1]);\n-            }\n-        }\n-\n-        if ($fieldName === 'Manifest Date') {\n-            if (preg_match('/Manifest\\s+Date\\s*:\\s*([0-9\\/\\-]+)/i', $content, $matches)) {\n-                return trim($matches[1]);\n-            }\n-        }\n-\n-        return 'Not Found';\n-    }\n-\n-    private function extractWasteFromPart3(string $text): string\n-    {\n-        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n\\s*([^\\n]+)/is', $text, $matches)) {\n-            return trim($matches[1]);\n-        }\n-        return 'Not Found';\n-    }\n-\n-    private function extractQuantityFromPart3(string $text): int\n-    {\n-        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n[^\\d]*(\\d+)/is', $text, $matches)) {\n-            return (int) $matches[1];\n-        }\n-        return 0;\n-    }\n-}\n-\n"
                },
                {
                    "date": 1766786002679,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,12 +1,13 @@\n <?php\n+\n namespace App\\Services\\Excel;\n \n+use App\\Services\\Dropbox\\DropboxApiService;\n+use App\\Services\\Pdf\\PdfParserService;\n use Illuminate\\Support\\Facades\\Log;\n use PhpOffice\\PhpSpreadsheet\\IOFactory;\n use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n-use App\\Services\\Dropbox\\DropboxApiService;\n-use App\\Services\\Pdf\\PdfParserService;\n \n class ExcelProcessorService\n {\n     private DropboxApiService $dropboxApi;\n@@ -29,14 +30,34 @@\n         if (!$excelContent) {\n             throw new \\Exception('Failed to download Excel file');\n         }\n \n-        $tempExcelPath = tempnam(sys_get_temp_dir(), 'excel_') . '.xlsx';\n+        $tempExcelPath = tempnam(sys_get_temp_dir(), 'excel_').'.xlsx';\n         file_put_contents($tempExcelPath, $excelContent);\n \n         $spreadsheet = IOFactory::load($tempExcelPath);\n-        $worksheet = $spreadsheet->getActiveSheet();\n \n+        // ===== FIX 1: Get the correct worksheet by name =====\n+        try {\n+            $worksheet = $spreadsheet->getSheetByName('ManifestDetails (2)');\n+            if (!$worksheet) {\n+                Log::warning(\"Sheet 'ManifestDetails (2)' not found, trying by index...\");\n+                // If not found by name, try to get second sheet (index 1)\n+                if ($spreadsheet->getSheetCount() > 1) {\n+                    $worksheet = $spreadsheet->getSheet(1);\n+                    Log::info(\"Using sheet: \" . $worksheet->getTitle());\n+                } else {\n+                    $worksheet = $spreadsheet->getActiveSheet();\n+                    Log::info(\"Using active sheet: \" . $worksheet->getTitle());\n+                }\n+            } else {\n+                Log::info(\"✓ Found sheet: ManifestDetails (2)\");\n+            }\n+        } catch (\\Exception $e) {\n+            Log::error(\"Error getting worksheet: \" . $e->getMessage());\n+            $worksheet = $spreadsheet->getActiveSheet();\n+        }\n+\n         $updatedCount = 0;\n         $processedFiles = [];\n \n         foreach ($matchingFiles as $file) {\n@@ -93,36 +114,73 @@\n \n     private function updateExcelRow($worksheet, array $pdfData): bool\n     {\n         try {\n+            // ===== FIX 2: Find the correct data range =====\n             $highestRow = $worksheet->getHighestRow();\n             $manifestNumber = trim($pdfData['manifest_number']);\n \n-            // Check for duplicates\n-            for ($row = 2; $row <= $highestRow; $row++) {\n+            Log::info(\"=== Updating Excel ===\");\n+            Log::info(\"Sheet: \" . $worksheet->getTitle());\n+            Log::info(\"Highest Row: {$highestRow}\");\n+            Log::info(\"Looking for Manifest: {$manifestNumber}\");\n+\n+            // ===== FIX 3: Find where data actually starts =====\n+            $dataStartRow = null;\n+            for ($row = 1; $row <= $highestRow; $row++) {\n+                $cellA = trim((string) $worksheet->getCell(\"A{$row}\")->getValue());\n+\n+                // Check if this looks like a manifest number (numeric)\n+                if (is_numeric($cellA) && strlen($cellA) >= 6) {\n+                    $dataStartRow = $row;\n+                    Log::info(\"Found data start at row {$row}\");\n+                    break;\n+                }\n+            }\n+\n+            if (!$dataStartRow) {\n+                Log::error(\"Could not find data start row!\");\n+                return false;\n+            }\n+\n+            // ===== FIX 4: Check for duplicates in the actual data range =====\n+            for ($row = $dataStartRow; $row <= $highestRow; $row++) {\n                 $cellValue = trim((string) $worksheet->getCell(\"A{$row}\")->getValue());\n+\n                 if ($cellValue == $manifestNumber) {\n-                    Log::info(\"⚠️ Manifest {$manifestNumber} already exists - SKIPPING\");\n+                    Log::info(\"⚠️ Manifest {$manifestNumber} already exists in row {$row} - SKIPPING\");\n                     return false;\n                 }\n             }\n \n-            // Add new row\n+            // ===== FIX 5: Add new row right after the last data row =====\n             $newRow = $highestRow + 1;\n \n-            $worksheet->setCellValue(\"A{$newRow}\", $pdfData['manifest_number']);\n-            $worksheet->setCellValue(\"B{$newRow}\", $pdfData['manifest_date']);\n-            $worksheet->setCellValue(\"C{$newRow}\", $pdfData['waste_description']);\n-            $worksheet->setCellValue(\"D{$newRow}\", $pdfData['wastes_location']);\n-            $worksheet->setCellValue(\"E{$newRow}\", $pdfData['recycled_plastic']);\n-            $worksheet->setCellValue(\"F{$newRow}\", $pdfData['recycled_paper']);\n-            $worksheet->setCellValue(\"G{$newRow}\", $pdfData['recycled_wood']);\n-            $worksheet->setCellValue(\"H{$newRow}\", $pdfData['recycled_steel']);\n+            Log::info(\"Adding new row at: {$newRow}\");\n+            Log::info(\"Data to insert: \" . json_encode($pdfData));\n \n+            // Insert data in correct columns\n+            $worksheet->setCellValue(\"A{$newRow}\", $pdfData['manifest_number']);        // Manifest Number\n+            $worksheet->setCellValue(\"B{$newRow}\", $pdfData['manifest_date']);          // Date\n+            $worksheet->setCellValue(\"C{$newRow}\", $pdfData['waste_description']);      // Waste Description\n+            $worksheet->setCellValue(\"D{$newRow}\", $pdfData['wastes_location']);        // Location\n+            $worksheet->setCellValue(\"E{$newRow}\", $pdfData['recycled_plastic']);       // Plastic (0)\n+            $worksheet->setCellValue(\"F{$newRow}\", $pdfData['recycled_paper']);         // Paper (0)\n+            $worksheet->setCellValue(\"G{$newRow}\", $pdfData['recycled_wood']);          // Wood (0)\n+            $worksheet->setCellValue(\"H{$newRow}\", $pdfData['recycled_steel']);         // Steel (0)\n+\n+            // ===== FIX 6: Verify data was written =====\n+            $verifyA = $worksheet->getCell(\"A{$newRow}\")->getValue();\n+            $verifyB = $worksheet->getCell(\"B{$newRow}\")->getValue();\n+            $verifyC = $worksheet->getCell(\"C{$newRow}\")->getValue();\n+\n             Log::info(\"✓ Row {$newRow} added successfully\");\n+            Log::info(\"Verification - A: {$verifyA}, B: {$verifyB}, C: {$verifyC}\");\n+\n             return true;\n         } catch (\\Exception $e) {\n             Log::error('Excel Update Error: ' . $e->getMessage());\n+            Log::error('Stack trace: ' . $e->getTraceAsString());\n             return false;\n         }\n     }\n-}\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766786417825,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,9 +10,8 @@\n \n class ExcelProcessorService\n {\n     private DropboxApiService $dropboxApi;\n-\n     private PdfParserService $pdfParser;\n \n     public function __construct(DropboxApiService $dropboxApi, PdfParserService $pdfParser)\n     {\n@@ -36,14 +35,12 @@\n         file_put_contents($tempExcelPath, $excelContent);\n \n         $spreadsheet = IOFactory::load($tempExcelPath);\n \n-        // ===== FIX 1: Get the correct worksheet by name =====\n         try {\n             $worksheet = $spreadsheet->getSheetByName('ManifestDetails (2)');\n             if (! $worksheet) {\n                 Log::warning(\"Sheet 'ManifestDetails (2)' not found, trying by index...\");\n-                // If not found by name, try to get second sheet (index 1)\n                 if ($spreadsheet->getSheetCount() > 1) {\n                     $worksheet = $spreadsheet->getSheet(1);\n                     Log::info('Using sheet: '.$worksheet->getTitle());\n                 } else {\n@@ -73,9 +70,8 @@\n                     'name' => $file['name'],\n                     'status' => 'error',\n                     'message' => 'Failed to download PDF',\n                 ];\n-\n                 continue;\n             }\n \n             $pdfData = $this->pdfParser->extractPdfData($pdfContent);\n@@ -89,8 +85,14 @@\n                         'name' => $file['name'],\n                         'status' => 'success',\n                         'manifest' => $pdfData['manifest_number'],\n                     ];\n+                } else {\n+                    $processedFiles[] = [\n+                        'name' => $file['name'],\n+                        'status' => 'skipped',\n+                        'message' => 'Duplicate manifest number',\n+                    ];\n                 }\n             } else {\n                 $processedFiles[] = [\n                     'name' => $file['name'],\n@@ -116,76 +118,97 @@\n \n     private function updateExcelRow($worksheet, array $pdfData): bool\n     {\n         try {\n-            // ===== FIX 2: Find the correct data range =====\n             $highestRow = $worksheet->getHighestRow();\n             $manifestNumber = trim($pdfData['manifest_number']);\n \n             Log::info('=== Updating Excel ===');\n             Log::info('Sheet: '.$worksheet->getTitle());\n             Log::info(\"Highest Row: {$highestRow}\");\n             Log::info(\"Looking for Manifest: {$manifestNumber}\");\n \n-            // ===== FIX 3: Find where data actually starts =====\n+            // ===== FIX: البحث عن بداية البيانات من Column B (Manifest Number) =====\n             $dataStartRow = null;\n             for ($row = 1; $row <= $highestRow; $row++) {\n-                $cellA = trim((string) $worksheet->getCell(\"A{$row}\")->getValue());\n+                $cellB = trim((string) $worksheet->getCell(\"B{$row}\")->getValue());\n \n-                // Check if this looks like a manifest number (numeric)\n-                if (is_numeric($cellA) && strlen($cellA) >= 6) {\n+                // التحقق من أن القيمة رقم manifest صحيح\n+                if (is_numeric($cellB) && strlen($cellB) >= 7) {\n                     $dataStartRow = $row;\n-                    Log::info(\"Found data start at row {$row}\");\n+                    Log::info(\"Found data start at row {$row} with manifest: {$cellB}\");\n                     break;\n                 }\n             }\n \n-            if (! $dataStartRow) {\n-                Log::error('Could not find data start row!');\n-\n+            if (!$dataStartRow) {\n+                Log::error('Could not find data start row in column B!');\n                 return false;\n             }\n \n-            // ===== FIX 4: Check for duplicates in the actual data range =====\n+            // ===== التحقق من عدم وجود تكرار في Column B =====\n             for ($row = $dataStartRow; $row <= $highestRow; $row++) {\n-                $cellValue = trim((string) $worksheet->getCell(\"A{$row}\")->getValue());\n+                $cellValue = trim((string) $worksheet->getCell(\"B{$row}\")->getValue());\n \n                 if ($cellValue == $manifestNumber) {\n                     Log::info(\"⚠️ Manifest {$manifestNumber} already exists in row {$row} - SKIPPING\");\n-\n                     return false;\n                 }\n             }\n \n-            // ===== FIX 5: Add new row right after the last data row =====\n+            // ===== إضافة صف جديد =====\n             $newRow = $highestRow + 1;\n \n             Log::info(\"Adding new row at: {$newRow}\");\n             Log::info('Data to insert: '.json_encode($pdfData));\n \n-            // Insert data in correct columns\n-            $worksheet->setCellValue(\"A{$newRow}\", $pdfData['manifest_number']);        // Manifest Number\n-            $worksheet->setCellValue(\"B{$newRow}\", $pdfData['manifest_date']);          // Date\n-            $worksheet->setCellValue(\"C{$newRow}\", $pdfData['waste_description']);      // Waste Description\n-            $worksheet->setCellValue(\"D{$newRow}\", $pdfData['wastes_location']);        // Location\n-            $worksheet->setCellValue(\"E{$newRow}\", $pdfData['recycled_plastic']);       // Plastic (0)\n-            $worksheet->setCellValue(\"F{$newRow}\", $pdfData['recycled_paper']);         // Paper (0)\n-            $worksheet->setCellValue(\"G{$newRow}\", $pdfData['recycled_wood']);          // Wood (0)\n-            $worksheet->setCellValue(\"H{$newRow}\", $pdfData['recycled_steel']);         // Steel (0)\n+            // ===== تعيين القيم في الأعمدة الصحيحة حسب الصورة =====\n+            // Column A: # (Row Number - يمكن تركه فارغ أو وضع رقم)\n+            $worksheet->setCellValue(\"A{$newRow}\", $newRow - $dataStartRow + 1);\n \n-            // ===== FIX 6: Verify data was written =====\n-            $verifyA = $worksheet->getCell(\"A{$newRow}\")->getValue();\n+            // Column B: Manifest Number\n+            $worksheet->setCellValue(\"B{$newRow}\", $pdfData['manifest_number']);\n+\n+            // Column C: Manifest Date\n+            $worksheet->setCellValue(\"C{$newRow}\", $pdfData['manifest_date']);\n+\n+            // Column D: Waste Description\n+            $worksheet->setCellValue(\"D{$newRow}\", $pdfData['waste_description']);\n+\n+            // Column E: General Waste Quantity\n+            $worksheet->setCellValue(\"E{$newRow}\", $pdfData['general_waste_quantity'] ?? '');\n+\n+            // Column F: Recycled Steel\n+            $worksheet->setCellValue(\"F{$newRow}\", $pdfData['recycled_steel'] ?? '0');\n+\n+            // Column G: Recycled Concrete\n+            $worksheet->setCellValue(\"G{$newRow}\", $pdfData['recycled_concrete'] ?? '0');\n+\n+            // Column H: Recycled Wood\n+            $worksheet->setCellValue(\"H{$newRow}\", $pdfData['recycled_wood'] ?? '0');\n+\n+            // Column I: Recycled Paper & CB\n+            $worksheet->setCellValue(\"I{$newRow}\", $pdfData['recycled_paper'] ?? '0');\n+\n+            // Column J: Recycled Plastic\n+            $worksheet->setCellValue(\"J{$newRow}\", $pdfData['recycled_plastic'] ?? '0');\n+\n+            // Column K: Wastes Location\n+            $worksheet->setCellValue(\"K{$newRow}\", $pdfData['wastes_location']);\n+\n+            // ===== التحقق من الكتابة =====\n             $verifyB = $worksheet->getCell(\"B{$newRow}\")->getValue();\n             $verifyC = $worksheet->getCell(\"C{$newRow}\")->getValue();\n+            $verifyD = $worksheet->getCell(\"D{$newRow}\")->getValue();\n \n             Log::info(\"✓ Row {$newRow} added successfully\");\n-            Log::info(\"Verification - A: {$verifyA}, B: {$verifyB}, C: {$verifyC}\");\n+            Log::info(\"Verification - Manifest: {$verifyB}, Date: {$verifyC}, Description: {$verifyD}\");\n \n             return true;\n+\n         } catch (\\Exception $e) {\n             Log::error('Excel Update Error: '.$e->getMessage());\n             Log::error('Stack trace: '.$e->getTraceAsString());\n-\n             return false;\n         }\n     }\n-}\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1766740566119,
            "name": "Commit-0",
            "content": "<?php\n"
        }
    ]
}