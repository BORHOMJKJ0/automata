{
    "sourceFile": "app/Services/Pdf/PdfParserService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1766740561276,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766740957440,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,228 @@\n-<?php\n\\ No newline at end of file\n+<?php\n+namespace App\\Services\\Excel;\n+\n+use Illuminate\\Support\\Facades\\Log;\n+use PhpOffice\\PhpSpreadsheet\\IOFactory;\n+use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n+use App\\Services\\Dropbox\\DropboxApiService;\n+use App\\Services\\Pdf\\PdfParserService;\n+\n+class ExcelProcessorService\n+{\n+    private DropboxApiService $dropboxApi;\n+    private PdfParserService $pdfParser;\n+\n+    public function __construct(DropboxApiService $dropboxApi, PdfParserService $pdfParser)\n+    {\n+        $this->dropboxApi = $dropboxApi;\n+        $this->pdfParser = $pdfParser;\n+    }\n+\n+    public function processExcelWithPdfs(\n+        string $accessToken,\n+        string $sharedUrl,\n+        string $excelPath,\n+        array $matchingFiles\n+    ): array {\n+        $excelContent = $this->dropboxApi->downloadFileContent($accessToken, $sharedUrl, $excelPath);\n+\n+        if (!$excelContent) {\n+            throw new \\Exception('Failed to download Excel file');\n+        }\n+\n+        $tempExcelPath = tempnam(sys_get_temp_dir(), 'excel_') . '.xlsx';\n+        file_put_contents($tempExcelPath, $excelContent);\n+\n+        $spreadsheet = IOFactory::load($tempExcelPath);\n+        $worksheet = $spreadsheet->getActiveSheet();\n+\n+        $updatedCount = 0;\n+        $processedFiles = [];\n+\n+        foreach ($matchingFiles as $file) {\n+            if (!str_ends_with(strtolower($file['name']), '.pdf')) {\n+                continue;\n+            }\n+\n+            $pdfContent = $this->dropboxApi->downloadFileContent($accessToken, $sharedUrl, $file['path']);\n+\n+            if (!$pdfContent) {\n+                $processedFiles[] = [\n+                    'name' => $file['name'],\n+                    'status' => 'error',\n+                    'message' => 'Failed to download PDF',\n+                ];\n+                continue;\n+            }\n+\n+            $pdfData = $this->pdfParser->extractPdfData($pdfContent);\n+\n+            if ($pdfData && $pdfData['manifest_number'] !== 'Not Found') {\n+                $updated = $this->updateExcelRow($worksheet, $pdfData);\n+\n+                if ($updated) {\n+                    $updatedCount++;\n+                    $processedFiles[] = [\n+                        'name' => $file['name'],\n+                        'status' => 'success',\n+                        'manifest' => $pdfData['manifest_number'],\n+                    ];\n+                }\n+            } else {\n+                $processedFiles[] = [\n+                    'name' => $file['name'],\n+                    'status' => 'warning',\n+                    'message' => 'No valid data found',\n+                ];\n+            }\n+        }\n+\n+        $writer = new Xlsx($spreadsheet);\n+        $writer->save($tempExcelPath);\n+        $updatedContent = file_get_contents($tempExcelPath);\n+        unlink($tempExcelPath);\n+\n+        $uploaded = $this->dropboxApi->uploadFile($accessToken, $excelPath, $updatedContent, true);\n+\n+        return [\n+            'success' => $uploaded,\n+            'updatedCount' => $updatedCount,\n+            'processedFiles' => $processedFiles,\n+        ];\n+    }\n+\n+    private function updateExcelRow($worksheet, array $pdfData): bool\n+    {\n+        try {\n+            $highestRow = $worksheet->getHighestRow();\n+            $manifestNumber = trim($pdfData['manifest_number']);\n+\n+            // Check for duplicates\n+            for ($row = 2; $row <= $highestRow; $row++) {\n+                $cellValue = trim((string) $worksheet->getCell(\"A{$row}\")->getValue());\n+                if ($cellValue == $manifestNumber) {\n+                    Log::info(\"⚠️ Manifest {$manifestNumber} already exists - SKIPPING\");\n+                    return false;\n+                }\n+            }\n+\n+            // Add new row\n+            $newRow = $highestRow + 1;\n+\n+            $worksheet->setCellValue(\"A{$newRow}\", $pdfData['manifest_number']);\n+            $worksheet->setCellValue(\"B{$newRow}\", $pdfData['manifest_date']);\n+            $worksheet->setCellValue(\"C{$newRow}\", $pdfData['waste_description']);\n+            $worksheet->setCellValue(\"D{$newRow}\", $pdfData['wastes_location']);\n+            $worksheet->setCellValue(\"E{$newRow}\", $pdfData['recycled_plastic']);\n+            $worksheet->setCellValue(\"F{$newRow}\", $pdfData['recycled_paper']);\n+            $worksheet->setCellValue(\"G{$newRow}\", $pdfData['recycled_wood']);\n+            $worksheet->setCellValue(\"H{$newRow}\", $pdfData['recycled_steel']);\n+\n+            Log::info(\"✓ Row {$newRow} added successfully\");\n+            return true;\n+        } catch (\\Exception $e) {\n+            Log::error('Excel Update Error: ' . $e->getMessage());\n+            return false;\n+        }\n+    }\n+}\n+\n+// ==================== 4. PdfParserService.php ====================\n+namespace App\\Services\\Pdf;\n+\n+use Illuminate\\Support\\Facades\\Log;\n+use Smalot\\PdfParser\\Parser as PdfParser;\n+\n+class PdfParserService\n+{\n+    public function extractText(string $pdfContent): ?string\n+    {\n+        try {\n+            $tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n+            file_put_contents($tempPdfPath, $pdfContent);\n+\n+            $parser = new PdfParser;\n+            $pdf = $parser->parseFile($tempPdfPath);\n+            $text = $pdf->getText();\n+            unlink($tempPdfPath);\n+\n+            return $text;\n+        } catch (\\Exception $e) {\n+            Log::error('PDF Parse Error: ' . $e->getMessage());\n+            return null;\n+        }\n+    }\n+\n+    public function extractPdfData(string $pdfContent): ?array\n+    {\n+        $text = $this->extractText($pdfContent);\n+\n+        if (!$text || strlen($text) < 50) {\n+            return null;\n+        }\n+\n+        $data = [\n+            'manifest_number' => $this->extractValue($text, 'Manifest Number'),\n+            'manifest_date' => $this->extractValue($text, 'Manifest Date'),\n+            'wastes_location' => $this->extractValue($text, 'Wastes Location'),\n+            'waste_description' => $this->extractWasteFromPart3($text),\n+            'quantity' => $this->extractQuantityFromPart3($text),\n+        ];\n+\n+        $wasteDesc = strtolower($data['waste_description']);\n+        $data['recycled_plastic'] = (strpos($wasteDesc, 'plastic') !== false) ? $data['quantity'] : 0;\n+        $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ? $data['quantity'] : 0;\n+        $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $data['quantity'] : 0;\n+        $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false) ? $data['quantity'] : 0;\n+\n+        return $data;\n+    }\n+\n+    public function extractValue(string $content, string $fieldName): string\n+    {\n+        $content = preg_replace('/^\\xEF\\xBB\\xBF/', '', $content);\n+        $content = preg_replace('/\\r\\n/', \"\\n\", $content);\n+\n+        if ($fieldName === 'Producer Name') {\n+            if (preg_match('/Producer\\s+Name\\s*:\\s*\\n\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade License|Mobile|Email|Company Name|Part \\d+|$))/is', $content, $matches)) {\n+                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+            }\n+        }\n+\n+        if ($fieldName === 'Wastes Location') {\n+            if (preg_match('/Wastes?\\s+Location\\s*:\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n+                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+            }\n+        }\n+\n+        if ($fieldName === 'Manifest Number') {\n+            if (preg_match('/Manifest\\s+Number\\s*:\\s*([0-9]+)/i', $content, $matches)) {\n+                return trim($matches[1]);\n+            }\n+        }\n+\n+        if ($fieldName === 'Manifest Date') {\n+            if (preg_match('/Manifest\\s+Date\\s*:\\s*([0-9\\/\\-]+)/i', $content, $matches)) {\n+                return trim($matches[1]);\n+            }\n+        }\n+\n+        return 'Not Found';\n+    }\n+\n+    private function extractWasteFromPart3(string $text): string\n+    {\n+        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n\\s*([^\\n]+)/is', $text, $matches)) {\n+            return trim($matches[1]);\n+        }\n+        return 'Not Found';\n+    }\n+\n+    private function extractQuantityFromPart3(string $text): int\n+    {\n+        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n[^\\d]*(\\d+)/is', $text, $matches)) {\n+            return (int) $matches[1];\n+        }\n+        return 0;\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766740968212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,228 +0,0 @@\n-<?php\n-namespace App\\Services\\Excel;\n-\n-use Illuminate\\Support\\Facades\\Log;\n-use PhpOffice\\PhpSpreadsheet\\IOFactory;\n-use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n-use App\\Services\\Dropbox\\DropboxApiService;\n-use App\\Services\\Pdf\\PdfParserService;\n-\n-class ExcelProcessorService\n-{\n-    private DropboxApiService $dropboxApi;\n-    private PdfParserService $pdfParser;\n-\n-    public function __construct(DropboxApiService $dropboxApi, PdfParserService $pdfParser)\n-    {\n-        $this->dropboxApi = $dropboxApi;\n-        $this->pdfParser = $pdfParser;\n-    }\n-\n-    public function processExcelWithPdfs(\n-        string $accessToken,\n-        string $sharedUrl,\n-        string $excelPath,\n-        array $matchingFiles\n-    ): array {\n-        $excelContent = $this->dropboxApi->downloadFileContent($accessToken, $sharedUrl, $excelPath);\n-\n-        if (!$excelContent) {\n-            throw new \\Exception('Failed to download Excel file');\n-        }\n-\n-        $tempExcelPath = tempnam(sys_get_temp_dir(), 'excel_') . '.xlsx';\n-        file_put_contents($tempExcelPath, $excelContent);\n-\n-        $spreadsheet = IOFactory::load($tempExcelPath);\n-        $worksheet = $spreadsheet->getActiveSheet();\n-\n-        $updatedCount = 0;\n-        $processedFiles = [];\n-\n-        foreach ($matchingFiles as $file) {\n-            if (!str_ends_with(strtolower($file['name']), '.pdf')) {\n-                continue;\n-            }\n-\n-            $pdfContent = $this->dropboxApi->downloadFileContent($accessToken, $sharedUrl, $file['path']);\n-\n-            if (!$pdfContent) {\n-                $processedFiles[] = [\n-                    'name' => $file['name'],\n-                    'status' => 'error',\n-                    'message' => 'Failed to download PDF',\n-                ];\n-                continue;\n-            }\n-\n-            $pdfData = $this->pdfParser->extractPdfData($pdfContent);\n-\n-            if ($pdfData && $pdfData['manifest_number'] !== 'Not Found') {\n-                $updated = $this->updateExcelRow($worksheet, $pdfData);\n-\n-                if ($updated) {\n-                    $updatedCount++;\n-                    $processedFiles[] = [\n-                        'name' => $file['name'],\n-                        'status' => 'success',\n-                        'manifest' => $pdfData['manifest_number'],\n-                    ];\n-                }\n-            } else {\n-                $processedFiles[] = [\n-                    'name' => $file['name'],\n-                    'status' => 'warning',\n-                    'message' => 'No valid data found',\n-                ];\n-            }\n-        }\n-\n-        $writer = new Xlsx($spreadsheet);\n-        $writer->save($tempExcelPath);\n-        $updatedContent = file_get_contents($tempExcelPath);\n-        unlink($tempExcelPath);\n-\n-        $uploaded = $this->dropboxApi->uploadFile($accessToken, $excelPath, $updatedContent, true);\n-\n-        return [\n-            'success' => $uploaded,\n-            'updatedCount' => $updatedCount,\n-            'processedFiles' => $processedFiles,\n-        ];\n-    }\n-\n-    private function updateExcelRow($worksheet, array $pdfData): bool\n-    {\n-        try {\n-            $highestRow = $worksheet->getHighestRow();\n-            $manifestNumber = trim($pdfData['manifest_number']);\n-\n-            // Check for duplicates\n-            for ($row = 2; $row <= $highestRow; $row++) {\n-                $cellValue = trim((string) $worksheet->getCell(\"A{$row}\")->getValue());\n-                if ($cellValue == $manifestNumber) {\n-                    Log::info(\"⚠️ Manifest {$manifestNumber} already exists - SKIPPING\");\n-                    return false;\n-                }\n-            }\n-\n-            // Add new row\n-            $newRow = $highestRow + 1;\n-\n-            $worksheet->setCellValue(\"A{$newRow}\", $pdfData['manifest_number']);\n-            $worksheet->setCellValue(\"B{$newRow}\", $pdfData['manifest_date']);\n-            $worksheet->setCellValue(\"C{$newRow}\", $pdfData['waste_description']);\n-            $worksheet->setCellValue(\"D{$newRow}\", $pdfData['wastes_location']);\n-            $worksheet->setCellValue(\"E{$newRow}\", $pdfData['recycled_plastic']);\n-            $worksheet->setCellValue(\"F{$newRow}\", $pdfData['recycled_paper']);\n-            $worksheet->setCellValue(\"G{$newRow}\", $pdfData['recycled_wood']);\n-            $worksheet->setCellValue(\"H{$newRow}\", $pdfData['recycled_steel']);\n-\n-            Log::info(\"✓ Row {$newRow} added successfully\");\n-            return true;\n-        } catch (\\Exception $e) {\n-            Log::error('Excel Update Error: ' . $e->getMessage());\n-            return false;\n-        }\n-    }\n-}\n-\n-// ==================== 4. PdfParserService.php ====================\n-namespace App\\Services\\Pdf;\n-\n-use Illuminate\\Support\\Facades\\Log;\n-use Smalot\\PdfParser\\Parser as PdfParser;\n-\n-class PdfParserService\n-{\n-    public function extractText(string $pdfContent): ?string\n-    {\n-        try {\n-            $tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n-            file_put_contents($tempPdfPath, $pdfContent);\n-\n-            $parser = new PdfParser;\n-            $pdf = $parser->parseFile($tempPdfPath);\n-            $text = $pdf->getText();\n-            unlink($tempPdfPath);\n-\n-            return $text;\n-        } catch (\\Exception $e) {\n-            Log::error('PDF Parse Error: ' . $e->getMessage());\n-            return null;\n-        }\n-    }\n-\n-    public function extractPdfData(string $pdfContent): ?array\n-    {\n-        $text = $this->extractText($pdfContent);\n-\n-        if (!$text || strlen($text) < 50) {\n-            return null;\n-        }\n-\n-        $data = [\n-            'manifest_number' => $this->extractValue($text, 'Manifest Number'),\n-            'manifest_date' => $this->extractValue($text, 'Manifest Date'),\n-            'wastes_location' => $this->extractValue($text, 'Wastes Location'),\n-            'waste_description' => $this->extractWasteFromPart3($text),\n-            'quantity' => $this->extractQuantityFromPart3($text),\n-        ];\n-\n-        $wasteDesc = strtolower($data['waste_description']);\n-        $data['recycled_plastic'] = (strpos($wasteDesc, 'plastic') !== false) ? $data['quantity'] : 0;\n-        $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ? $data['quantity'] : 0;\n-        $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $data['quantity'] : 0;\n-        $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false) ? $data['quantity'] : 0;\n-\n-        return $data;\n-    }\n-\n-    public function extractValue(string $content, string $fieldName): string\n-    {\n-        $content = preg_replace('/^\\xEF\\xBB\\xBF/', '', $content);\n-        $content = preg_replace('/\\r\\n/', \"\\n\", $content);\n-\n-        if ($fieldName === 'Producer Name') {\n-            if (preg_match('/Producer\\s+Name\\s*:\\s*\\n\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade License|Mobile|Email|Company Name|Part \\d+|$))/is', $content, $matches)) {\n-                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-            }\n-        }\n-\n-        if ($fieldName === 'Wastes Location') {\n-            if (preg_match('/Wastes?\\s+Location\\s*:\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n-                return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-            }\n-        }\n-\n-        if ($fieldName === 'Manifest Number') {\n-            if (preg_match('/Manifest\\s+Number\\s*:\\s*([0-9]+)/i', $content, $matches)) {\n-                return trim($matches[1]);\n-            }\n-        }\n-\n-        if ($fieldName === 'Manifest Date') {\n-            if (preg_match('/Manifest\\s+Date\\s*:\\s*([0-9\\/\\-]+)/i', $content, $matches)) {\n-                return trim($matches[1]);\n-            }\n-        }\n-\n-        return 'Not Found';\n-    }\n-\n-    private function extractWasteFromPart3(string $text): string\n-    {\n-        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n\\s*([^\\n]+)/is', $text, $matches)) {\n-            return trim($matches[1]);\n-        }\n-        return 'Not Found';\n-    }\n-\n-    private function extractQuantityFromPart3(string $text): int\n-    {\n-        if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n[^\\d]*(\\d+)/is', $text, $matches)) {\n-            return (int) $matches[1];\n-        }\n-        return 0;\n-    }\n-}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766740995547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,98 @@\n+// ==================== 4. PdfParserService.php ====================\n+namespace App\\Services\\Pdf;\n+\n+use Illuminate\\Support\\Facades\\Log;\n+use Smalot\\PdfParser\\Parser as PdfParser;\n+\n+class PdfParserService\n+{\n+public function extractText(string $pdfContent): ?string\n+{\n+try {\n+$tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n+file_put_contents($tempPdfPath, $pdfContent);\n+\n+$parser = new PdfParser;\n+$pdf = $parser->parseFile($tempPdfPath);\n+$text = $pdf->getText();\n+unlink($tempPdfPath);\n+\n+return $text;\n+} catch (\\Exception $e) {\n+Log::error('PDF Parse Error: ' . $e->getMessage());\n+return null;\n+}\n+}\n+\n+public function extractPdfData(string $pdfContent): ?array\n+{\n+$text = $this->extractText($pdfContent);\n+\n+if (!$text || strlen($text) < 50) { return null; } $data=[ 'manifest_number'=> $this->extractValue($text, 'Manifest\n+    Number'),\n+    'manifest_date' => $this->extractValue($text, 'Manifest Date'),\n+    'wastes_location' => $this->extractValue($text, 'Wastes Location'),\n+    'waste_description' => $this->extractWasteFromPart3($text),\n+    'quantity' => $this->extractQuantityFromPart3($text),\n+    ];\n+\n+    $wasteDesc = strtolower($data['waste_description']);\n+    $data['recycled_plastic'] = (strpos($wasteDesc, 'plastic') !== false) ? $data['quantity'] : 0;\n+    $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ?\n+    $data['quantity'] : 0;\n+    $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $data['quantity'] : 0;\n+    $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false) ?\n+    $data['quantity'] : 0;\n+\n+    return $data;\n+    }\n+\n+    public function extractValue(string $content, string $fieldName): string\n+    {\n+    $content = preg_replace('/^\\xEF\\xBB\\xBF/', '', $content);\n+    $content = preg_replace('/\\r\\n/', \"\\n\", $content);\n+\n+    if ($fieldName === 'Producer Name') {\n+    if (preg_match('/Producer\\s+Name\\s*:\\s*\\n\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade\n+    License|Mobile|Email|Company Name|Part \\d+|$))/is', $content, $matches)) {\n+    return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+    }\n+    }\n+\n+    if ($fieldName === 'Wastes Location') {\n+    if (preg_match('/Wastes?\\s+Location\\s*:\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n+    return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+    }\n+    }\n+\n+    if ($fieldName === 'Manifest Number') {\n+    if (preg_match('/Manifest\\s+Number\\s*:\\s*([0-9]+)/i', $content, $matches)) {\n+    return trim($matches[1]);\n+    }\n+    }\n+\n+    if ($fieldName === 'Manifest Date') {\n+    if (preg_match('/Manifest\\s+Date\\s*:\\s*([0-9\\/\\-]+)/i', $content, $matches)) {\n+    return trim($matches[1]);\n+    }\n+    }\n+\n+    return 'Not Found';\n+    }\n+\n+    private function extractWasteFromPart3(string $text): string\n+    {\n+    if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n\\s*([^\\n]+)/is', $text, $matches)) {\n+    return trim($matches[1]);\n+    }\n+    return 'Not Found';\n+    }\n+\n+    private function extractQuantityFromPart3(string $text): int\n+    {\n+    if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n[^\\d]*(\\d+)/is', $text, $matches)) {\n+    return (int) $matches[1];\n+    }\n+    return 0;\n+    }\n+    }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766741001819,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,5 @@\n-// ==================== 4. PdfParserService.php ====================\n-namespace App\\Services\\Pdf;\n+>namespace App\\Services\\Pdf;\n \n use Illuminate\\Support\\Facades\\Log;\n use Smalot\\PdfParser\\Parser as PdfParser;\n \n@@ -94,5 +93,5 @@\n     return (int) $matches[1];\n     }\n     return 0;\n     }\n-    }\n\\ No newline at end of file\n+    }\n"
                },
                {
                    "date": 1766860074633,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,97 +1,199 @@\n->namespace App\\Services\\Pdf;\n+<?php\n \n+namespace App\\Services\\Pdf;\n+\n use Illuminate\\Support\\Facades\\Log;\n use Smalot\\PdfParser\\Parser as PdfParser;\n \n class PdfParserService\n {\n-public function extractText(string $pdfContent): ?string\n-{\n-try {\n-$tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n-file_put_contents($tempPdfPath, $pdfContent);\n+    public function extractText(string $pdfContent): ?string\n+    {\n+        try {\n+            $tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n+            file_put_contents($tempPdfPath, $pdfContent);\n \n-$parser = new PdfParser;\n-$pdf = $parser->parseFile($tempPdfPath);\n-$text = $pdf->getText();\n-unlink($tempPdfPath);\n+            $parser = new PdfParser;\n+            $pdf = $parser->parseFile($tempPdfPath);\n+            $text = $pdf->getText();\n+            unlink($tempPdfPath);\n \n-return $text;\n-} catch (\\Exception $e) {\n-Log::error('PDF Parse Error: ' . $e->getMessage());\n-return null;\n-}\n-}\n+            return $text;\n+        } catch (\\Exception $e) {\n+            Log::error('PDF Parse Error: ' . $e->getMessage());\n+            return null;\n+        }\n+    }\n \n-public function extractPdfData(string $pdfContent): ?array\n-{\n-$text = $this->extractText($pdfContent);\n+    public function extractPdfData(string $pdfContent): ?array\n+    {\n+        Log::info(\"=== extractPdfData called ===\");\n \n-if (!$text || strlen($text) < 50) { return null; } $data=[ 'manifest_number'=> $this->extractValue($text, 'Manifest\n-    Number'),\n-    'manifest_date' => $this->extractValue($text, 'Manifest Date'),\n-    'wastes_location' => $this->extractValue($text, 'Wastes Location'),\n-    'waste_description' => $this->extractWasteFromPart3($text),\n-    'quantity' => $this->extractQuantityFromPart3($text),\n-    ];\n+        $text = $this->extractText($pdfContent);\n \n-    $wasteDesc = strtolower($data['waste_description']);\n-    $data['recycled_plastic'] = (strpos($wasteDesc, 'plastic') !== false) ? $data['quantity'] : 0;\n-    $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ?\n-    $data['quantity'] : 0;\n-    $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $data['quantity'] : 0;\n-    $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false) ?\n-    $data['quantity'] : 0;\n+        if (!$text) {\n+            Log::error(\"extractText returned null or empty\");\n+            return null;\n+        }\n \n-    return $data;\n+        $textLength = strlen($text);\n+        Log::info(\"PDF text extracted, length: {$textLength}\");\n+        Log::info(\"PDF text (first 1500 chars): \" . substr($text, 0, 1500));\n+\n+        if ($textLength < 50) {\n+            Log::error(\"PDF text too short (< 50 chars) - likely empty or scanned image\");\n+            return null;\n+        }\n+\n+        // Extract all fields\n+        $manifestNumber = $this->extractValue($text, 'Manifest Number');\n+        $manifestDate = $this->extractValue($text, 'Manifest Date');\n+        $wastesLocation = $this->extractValue($text, 'Wastes Location');\n+        $wasteDescription = $this->extractWasteFromPart3($text);\n+        $quantity = $this->extractQuantityFromPart3($text);\n+\n+        Log::info(\"Extracted values:\");\n+        Log::info(\"  - Manifest Number: '{$manifestNumber}'\");\n+        Log::info(\"  - Manifest Date: '{$manifestDate}'\");\n+        Log::info(\"  - Wastes Location: '{$wastesLocation}'\");\n+        Log::info(\"  - Waste Description: '{$wasteDescription}'\");\n+        Log::info(\"  - Quantity: {$quantity}\");\n+\n+        $data = [\n+            'manifest_number' => $manifestNumber,\n+            'manifest_date' => $manifestDate,\n+            'wastes_location' => $wastesLocation,\n+            'waste_description' => $wasteDescription,\n+            'quantity' => $quantity,\n+        ];\n+\n+        // Validate\n+        if ($manifestNumber === 'Not Found' || empty($manifestNumber)) {\n+            Log::error(\"❌ Manifest Number is 'Not Found' or empty - returning null\");\n+            return null;\n+        }\n+\n+        // Calculate recycled materials\n+        $wasteDesc = strtolower($wasteDescription);\n+        $data['recycled_plastic'] = (strpos($wasteDesc, 'plastic') !== false) ? $quantity : 0;\n+        $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ? $quantity : 0;\n+        $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $quantity : 0;\n+        $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false || strpos($wasteDesc, 'inert') !== false) ? $quantity : 0;\n+\n+        Log::info(\"Recycled materials calculated:\");\n+        Log::info(\"  - Plastic: {$data['recycled_plastic']}\");\n+        Log::info(\"  - Paper: {$data['recycled_paper']}\");\n+        Log::info(\"  - Wood: {$data['recycled_wood']}\");\n+        Log::info(\"  - Steel: {$data['recycled_steel']}\");\n+\n+        Log::info(\"✓ PDF data extraction successful\");\n+\n+        return $data;\n     }\n \n     public function extractValue(string $content, string $fieldName): string\n     {\n-    $content = preg_replace('/^\\xEF\\xBB\\xBF/', '', $content);\n-    $content = preg_replace('/\\r\\n/', \"\\n\", $content);\n+        $content = preg_replace('/^\\xEF\\xBB\\xBF/', '', $content);\n+        $content = preg_replace('/\\r\\n/', \"\\n\", $content);\n \n-    if ($fieldName === 'Producer Name') {\n-    if (preg_match('/Producer\\s+Name\\s*:\\s*\\n\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade\n-    License|Mobile|Email|Company Name|Part \\d+|$))/is', $content, $matches)) {\n-    return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-    }\n-    }\n+        // Manifest Number\n+        if ($fieldName === 'Manifest Number') {\n+            $patterns = [\n+                '/Manifest\\s+Number\\s*:?\\s*([0-9]+)/i',\n+                '/Manifest\\s+No\\.?\\s*:?\\s*([0-9]+)/i',\n+                '/Manifest\\s+#\\s*:?\\s*([0-9]+)/i',\n+            ];\n \n-    if ($fieldName === 'Wastes Location') {\n-    if (preg_match('/Wastes?\\s+Location\\s*:\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n-    return trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-    }\n-    }\n+            foreach ($patterns as $pattern) {\n+                if (preg_match($pattern, $content, $matches)) {\n+                    Log::info(\"✓ Found Manifest Number: '{$matches[1]}' using pattern: {$pattern}\");\n+                    return trim($matches[1]);\n+                }\n+            }\n+            Log::warning(\"✗ Manifest Number not found\");\n+        }\n \n-    if ($fieldName === 'Manifest Number') {\n-    if (preg_match('/Manifest\\s+Number\\s*:\\s*([0-9]+)/i', $content, $matches)) {\n-    return trim($matches[1]);\n-    }\n-    }\n+        // Manifest Date\n+        if ($fieldName === 'Manifest Date') {\n+            $patterns = [\n+                '/Manifest\\s+Date\\s*:?\\s*([0-9]{1,2}[\\/\\-][0-9]{1,2}[\\/\\-][0-9]{2,4})/i',\n+                '/Date\\s*:?\\s*([0-9]{1,2}[\\/\\-][0-9]{1,2}[\\/\\-][0-9]{2,4})/i',\n+            ];\n \n-    if ($fieldName === 'Manifest Date') {\n-    if (preg_match('/Manifest\\s+Date\\s*:\\s*([0-9\\/\\-]+)/i', $content, $matches)) {\n-    return trim($matches[1]);\n-    }\n-    }\n+            foreach ($patterns as $pattern) {\n+                if (preg_match($pattern, $content, $matches)) {\n+                    Log::info(\"✓ Found Manifest Date: '{$matches[1]}'\");\n+                    return trim($matches[1]);\n+                }\n+            }\n+            Log::warning(\"✗ Manifest Date not found\");\n+        }\n \n-    return 'Not Found';\n+        // Producer Name\n+        if ($fieldName === 'Producer Name') {\n+            if (preg_match('/Producer\\s+Name\\s*:?\\s*\\n?\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade License|Mobile|Email|Part \\d+|$))/is', $content, $matches)) {\n+                $value = trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+                if (!empty($value)) {\n+                    Log::info(\"✓ Found Producer Name: '{$value}'\");\n+                    return $value;\n+                }\n+            }\n+            Log::warning(\"✗ Producer Name not found\");\n+        }\n+\n+        // Wastes Location\n+        if ($fieldName === 'Wastes Location') {\n+            if (preg_match('/Wastes?\\s+Location\\s*:?\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n+                $value = trim(preg_replace('/\\s+/', ' ', $matches[1]));\n+                if (!empty($value)) {\n+                    Log::info(\"✓ Found Wastes Location: '{$value}'\");\n+                    return $value;\n+                }\n+            }\n+            Log::warning(\"✗ Wastes Location not found\");\n+        }\n+\n+        return 'Not Found';\n     }\n \n     private function extractWasteFromPart3(string $text): string\n     {\n-    if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n\\s*([^\\n]+)/is', $text, $matches)) {\n-    return trim($matches[1]);\n+        // Try multiple patterns\n+        $patterns = [\n+            '/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n\\s*([^\\n]+)/is',\n+            '/Part 3.*?Storage.*?Waste Description.*?\\n\\s*([^\\n]+)/is',\n+            '/Waste\\s+Description\\s*:?\\s*\\n?\\s*([^\\n]+)/is',\n+        ];\n+\n+        foreach ($patterns as $pattern) {\n+            if (preg_match($pattern, $text, $matches)) {\n+                $value = trim($matches[1]);\n+                Log::info(\"✓ Found Waste Description: '{$value}'\");\n+                return $value;\n+            }\n+        }\n+\n+        Log::warning(\"✗ Waste Description not found\");\n+        return 'Not Found';\n     }\n-    return 'Not Found';\n-    }\n \n     private function extractQuantityFromPart3(string $text): int\n     {\n-    if (preg_match('/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n[^\\d]*(\\d+)/is', $text, $matches)) {\n-    return (int) $matches[1];\n+        $patterns = [\n+            '/Part 3.*?Waste Description\\s+Physical State\\s+Quantity.*?\\n[^\\d]*(\\d+)/is',\n+            '/Part 3.*?Solid\\s+(\\d+)/is',\n+            '/Quantity\\s*:?\\s*(\\d+)/is',\n+        ];\n+\n+        foreach ($patterns as $pattern) {\n+            if (preg_match($pattern, $text, $matches)) {\n+                $quantity = (int) $matches[1];\n+                Log::info(\"✓ Found Quantity: {$quantity}\");\n+                return $quantity;\n+            }\n+        }\n+\n+        Log::warning(\"✗ Quantity not found, returning 0\");\n+        return 0;\n     }\n-    return 0;\n-    }\n-    }\n+}\n"
                },
                {
                    "date": 1766874502636,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,9 @@\n {\n     public function extractText(string $pdfContent): ?string\n     {\n         try {\n-            $tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_') . '.pdf';\n+            $tempPdfPath = tempnam(sys_get_temp_dir(), 'pdf_').'.pdf';\n             file_put_contents($tempPdfPath, $pdfContent);\n \n             $parser = new PdfParser;\n             $pdf = $parser->parseFile($tempPdfPath);\n@@ -19,30 +19,33 @@\n             unlink($tempPdfPath);\n \n             return $text;\n         } catch (\\Exception $e) {\n-            Log::error('PDF Parse Error: ' . $e->getMessage());\n+            Log::error('PDF Parse Error: '.$e->getMessage());\n+\n             return null;\n         }\n     }\n \n     public function extractPdfData(string $pdfContent): ?array\n     {\n-        Log::info(\"=== extractPdfData called ===\");\n+        Log::info('=== extractPdfData called ===');\n \n         $text = $this->extractText($pdfContent);\n \n-        if (!$text) {\n-            Log::error(\"extractText returned null or empty\");\n+        if (! $text) {\n+            Log::error('extractText returned null or empty');\n+\n             return null;\n         }\n \n         $textLength = strlen($text);\n         Log::info(\"PDF text extracted, length: {$textLength}\");\n-        Log::info(\"PDF text (first 1500 chars): \" . substr($text, 0, 1500));\n+        Log::info('PDF text (first 1500 chars): '.substr($text, 0, 1500));\n \n         if ($textLength < 50) {\n-            Log::error(\"PDF text too short (< 50 chars) - likely empty or scanned image\");\n+            Log::error('PDF text too short (< 50 chars) - likely empty or scanned image');\n+\n             return null;\n         }\n \n         // Extract all fields\n@@ -51,9 +54,9 @@\n         $wastesLocation = $this->extractValue($text, 'Wastes Location');\n         $wasteDescription = $this->extractWasteFromPart3($text);\n         $quantity = $this->extractQuantityFromPart3($text);\n \n-        Log::info(\"Extracted values:\");\n+        Log::info('Extracted values:');\n         Log::info(\"  - Manifest Number: '{$manifestNumber}'\");\n         Log::info(\"  - Manifest Date: '{$manifestDate}'\");\n         Log::info(\"  - Wastes Location: '{$wastesLocation}'\");\n         Log::info(\"  - Waste Description: '{$wasteDescription}'\");\n@@ -69,8 +72,9 @@\n \n         // Validate\n         if ($manifestNumber === 'Not Found' || empty($manifestNumber)) {\n             Log::error(\"❌ Manifest Number is 'Not Found' or empty - returning null\");\n+\n             return null;\n         }\n \n         // Calculate recycled materials\n@@ -79,15 +83,15 @@\n         $data['recycled_paper'] = (strpos($wasteDesc, 'paper') !== false || strpos($wasteDesc, 'cb') !== false) ? $quantity : 0;\n         $data['recycled_wood'] = (strpos($wasteDesc, 'wood') !== false) ? $quantity : 0;\n         $data['recycled_steel'] = (strpos($wasteDesc, 'steel') !== false || strpos($wasteDesc, 'metal') !== false || strpos($wasteDesc, 'inert') !== false) ? $quantity : 0;\n \n-        Log::info(\"Recycled materials calculated:\");\n+        Log::info('Recycled materials calculated:');\n         Log::info(\"  - Plastic: {$data['recycled_plastic']}\");\n         Log::info(\"  - Paper: {$data['recycled_paper']}\");\n         Log::info(\"  - Wood: {$data['recycled_wood']}\");\n         Log::info(\"  - Steel: {$data['recycled_steel']}\");\n \n-        Log::info(\"✓ PDF data extraction successful\");\n+        Log::info('✓ PDF data extraction successful');\n \n         return $data;\n     }\n \n@@ -106,12 +110,13 @@\n \n             foreach ($patterns as $pattern) {\n                 if (preg_match($pattern, $content, $matches)) {\n                     Log::info(\"✓ Found Manifest Number: '{$matches[1]}' using pattern: {$pattern}\");\n+\n                     return trim($matches[1]);\n                 }\n             }\n-            Log::warning(\"✗ Manifest Number not found\");\n+            Log::warning('✗ Manifest Number not found');\n         }\n \n         // Manifest Date\n         if ($fieldName === 'Manifest Date') {\n@@ -122,36 +127,39 @@\n \n             foreach ($patterns as $pattern) {\n                 if (preg_match($pattern, $content, $matches)) {\n                     Log::info(\"✓ Found Manifest Date: '{$matches[1]}'\");\n+\n                     return trim($matches[1]);\n                 }\n             }\n-            Log::warning(\"✗ Manifest Date not found\");\n+            Log::warning('✗ Manifest Date not found');\n         }\n \n         // Producer Name\n         if ($fieldName === 'Producer Name') {\n             if (preg_match('/Producer\\s+Name\\s*:?\\s*\\n?\\s*([^\\n]+(?:\\n[^\\n:]+)*?)(?=\\n\\s*(?:Wastes Location|Trade License|Mobile|Email|Part \\d+|$))/is', $content, $matches)) {\n                 $value = trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-                if (!empty($value)) {\n+                if (! empty($value)) {\n                     Log::info(\"✓ Found Producer Name: '{$value}'\");\n+\n                     return $value;\n                 }\n             }\n-            Log::warning(\"✗ Producer Name not found\");\n+            Log::warning('✗ Producer Name not found');\n         }\n \n         // Wastes Location\n         if ($fieldName === 'Wastes Location') {\n             if (preg_match('/Wastes?\\s+Location\\s*:?\\s*\\n?\\s*([^\\n]+)/is', $content, $matches)) {\n                 $value = trim(preg_replace('/\\s+/', ' ', $matches[1]));\n-                if (!empty($value)) {\n+                if (! empty($value)) {\n                     Log::info(\"✓ Found Wastes Location: '{$value}'\");\n+\n                     return $value;\n                 }\n             }\n-            Log::warning(\"✗ Wastes Location not found\");\n+            Log::warning('✗ Wastes Location not found');\n         }\n \n         return 'Not Found';\n     }\n@@ -168,13 +176,15 @@\n         foreach ($patterns as $pattern) {\n             if (preg_match($pattern, $text, $matches)) {\n                 $value = trim($matches[1]);\n                 Log::info(\"✓ Found Waste Description: '{$value}'\");\n+\n                 return $value;\n             }\n         }\n \n-        Log::warning(\"✗ Waste Description not found\");\n+        Log::warning('✗ Waste Description not found');\n+\n         return 'Not Found';\n     }\n \n     private function extractQuantityFromPart3(string $text): int\n@@ -188,12 +198,14 @@\n         foreach ($patterns as $pattern) {\n             if (preg_match($pattern, $text, $matches)) {\n                 $quantity = (int) $matches[1];\n                 Log::info(\"✓ Found Quantity: {$quantity}\");\n+\n                 return $quantity;\n             }\n         }\n \n-        Log::warning(\"✗ Quantity not found, returning 0\");\n+        Log::warning('✗ Quantity not found, returning 0');\n+\n         return 0;\n     }\n }\n"
                }
            ],
            "date": 1766740561276,
            "name": "Commit-0",
            "content": "<?php"
        }
    ]
}