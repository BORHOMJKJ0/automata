{
    "sourceFile": "app/Services/Dropbox/FileSearchService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1766740567431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766740815300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,102 @@\n <?php\n+namespace App\\Http\\Controllers\\Dropbox;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Log;\n+use Illuminate\\Support\\Facades\\Session;\n+use App\\Http\\Controllers\\Controller;\n+use App\\Services\\Dropbox\\DropboxApiService;\n+use App\\Services\\Dropbox\\FileSearchService;\n+use App\\Services\\BitrixNotificationService;\n+\n+class DropboxSearchController extends Controller\n+{\n+    private DropboxApiService $dropboxApi;\n+    private FileSearchService $searchService;\n+    private BitrixNotificationService $bitrixService;\n+\n+    public function __construct(\n+        DropboxApiService $dropboxApi,\n+        FileSearchService $searchService,\n+        BitrixNotificationService $bitrixService\n+    ) {\n+        $this->middleware('web');\n+        $this->dropboxApi = $dropboxApi;\n+        $this->searchService = $searchService;\n+        $this->bitrixService = $bitrixService;\n+    }\n+\n+    public function searchAndMatch(Request $request)\n+    {\n+        $accessToken = Session::get('dropbox_access_token');\n+        \n+        if (!$accessToken) {\n+            return back()->with('error', 'يجب تسجيل الدخول أولاً');\n+        }\n+\n+        if ($request->isMethod('get')) {\n+            return view('dropbox.search-results', [\n+                'producerName' => '',\n+                'wastesLocation' => '',\n+                'matchingFiles' => [],\n+                'nonMatchingFiles' => [],\n+                'totalFiles' => 0,\n+                'allExcelFiles' => [],\n+                'sharedUrl' => $request->query('shared_url') ?? Session::get('current_shared_url'),\n+                'currentPath' => $request->query('current_path', '') ?? '',\n+            ]);\n+        }\n+\n+        $producerName = trim($request->input('producer_name', ''));\n+        $wastesLocation = trim($request->input('wastes_location', ''));\n+        $sharedUrl = $request->input('shared_url') ?? Session::get('current_shared_url');\n+        $currentPath = $request->input('current_path', '') ?? '';\n+\n+        if (empty($producerName) && empty($wastesLocation)) {\n+            return back()->with('error', 'الرجاء إدخال قيمة واحدة على الأقل للبحث');\n+        }\n+\n+        if (!$sharedUrl) {\n+            return back()->with('error', 'رابط مشارك مطلوب');\n+        }\n+\n+        try {\n+            Log::info('=== Starting Search ===');\n+\n+            $allEntries = $this->dropboxApi->getAllFilesRecursive($accessToken, $sharedUrl, $currentPath);\n+            \n+            $files = $this->searchService->categorizeFiles($allEntries);\n+            \n+            $results = $this->searchService->searchFiles(\n+                $accessToken,\n+                $sharedUrl,\n+                $files,\n+                $producerName,\n+                $wastesLocation\n+            );\n+\n+            if (count($results['matching']) > 0) {\n+                $this->bitrixService->notifySearchResults(\n+                    count($results['matching']),\n+                    $results['total'],\n+                    \"Producer: {$producerName}, Location: {$wastesLocation}\"\n+                );\n+            }\n+\n+            return view('dropbox.search-results', [\n+                'producerName' => $producerName,\n+                'wastesLocation' => $wastesLocation,\n+                'matchingFiles' => $results['matching'],\n+                'nonMatchingFiles' => $results['nonMatching'],\n+                'totalFiles' => $results['total'],\n+                'allExcelFiles' => $files['excel'],\n+                'sharedUrl' => $sharedUrl,\n+                'currentPath' => $currentPath,\n+            ]);\n+        } catch (\\Exception $e) {\n+            Log::error('Search Error: ' . $e->getMessage());\n+            return back()->with('error', 'خطأ: ' . $e->getMessage());\n+        }\n+    }\n+}\n+\n"
                },
                {
                    "date": 1766740851995,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,91 @@\n-<?php\n\\ No newline at end of file\n+<?php\n+namespace App\\Http\\Controllers\\Dropbox;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Log;\n+use Illuminate\\Support\\Facades\\Session;\n+use App\\Http\\Controllers\\Controller;\n+use App\\Services\\Dropbox\\DropboxApiService;\n+use App\\Services\\Excel\\ExcelProcessorService;\n+use App\\Services\\BitrixNotificationService;\n+\n+class DropboxExcelController extends Controller\n+{\n+    private DropboxApiService $dropboxApi;\n+    private ExcelProcessorService $excelProcessor;\n+    private BitrixNotificationService $bitrixService;\n+\n+    public function __construct(\n+        DropboxApiService $dropboxApi,\n+        ExcelProcessorService $excelProcessor,\n+        BitrixNotificationService $bitrixService\n+    ) {\n+        $this->middleware('web');\n+        $this->dropboxApi = $dropboxApi;\n+        $this->excelProcessor = $excelProcessor;\n+        $this->bitrixService = $bitrixService;\n+    }\n+\n+    public function processExcelUpdate(Request $request)\n+    {\n+        set_time_limit(600);\n+        ini_set('memory_limit', '512M');\n+\n+        $accessToken = Session::get('dropbox_access_token');\n+\n+        if (!$accessToken) {\n+            return back()->with('error', 'يجب تسجيل الدخول أولاً');\n+        }\n+\n+        $sharedUrl = $request->input('shared_url') ?? Session::get('current_shared_url');\n+        $matchingFiles = json_decode($request->input('matching_files'), true);\n+        $excelPath = $request->input('excel_file');\n+\n+        if (!$sharedUrl || !$excelPath || empty($matchingFiles)) {\n+            return back()->with('error', 'معلومات غير كاملة');\n+        }\n+\n+        try {\n+            Log::info('=== Starting Excel Update ===');\n+\n+            $result = $this->excelProcessor->processExcelWithPdfs(\n+                $accessToken,\n+                $sharedUrl,\n+                $excelPath,\n+                $matchingFiles\n+            );\n+\n+            if ($result['success']) {\n+                $this->bitrixService->notifyExcelProcessed(\n+                    count($matchingFiles),\n+                    $result['updatedCount'],\n+                    $excelPath\n+                );\n+\n+                return view('dropbox.process-results', [\n+                    'success' => true,\n+                    'updatedCount' => $result['updatedCount'],\n+                    'processedFiles' => $result['processedFiles'],\n+                    'newFilePath' => $excelPath,\n+                    'sharedUrl' => $sharedUrl,\n+                ]);\n+            }\n+\n+            return back()->with('error', 'فشل معالجة الملف');\n+        } catch (\\Exception $e) {\n+            Log::error('Process Excel Error: ' . $e->getMessage());\n+            return back()->with('error', 'خطأ: ' . $e->getMessage());\n+        }\n+    }\n+\n+    public function showProcessResults()\n+    {\n+        return view('dropbox.process-results', [\n+            'success' => session('success', false),\n+            'updatedCount' => session('updatedCount', 0),\n+            'processedFiles' => session('processedFiles', []),\n+            'newFilePath' => session('newFilePath', ''),\n+            'sharedUrl' => session('sharedUrl', ''),\n+        ]);\n+    }\n+}\n"
                },
                {
                    "date": 1766740881088,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -87,107 +87,5 @@\n             'newFilePath' => session('newFilePath', ''),\n             'sharedUrl' => session('sharedUrl', ''),\n         ]);\n     }\n-}\n-namespace App\\Http\\Controllers\\Dropbox;\n-\n-use Illuminate\\Http\\Request;\n-use Illuminate\\Support\\Facades\\Log;\n-use Illuminate\\Support\\Facades\\Session;\n-use App\\Http\\Controllers\\Controller;\n-use App\\Services\\Dropbox\\DropboxApiService;\n-use App\\Services\\Dropbox\\FileSearchService;\n-use App\\Services\\BitrixNotificationService;\n-\n-class DropboxSearchController extends Controller\n-{\n-    private DropboxApiService $dropboxApi;\n-    private FileSearchService $searchService;\n-    private BitrixNotificationService $bitrixService;\n-\n-    public function __construct(\n-        DropboxApiService $dropboxApi,\n-        FileSearchService $searchService,\n-        BitrixNotificationService $bitrixService\n-    ) {\n-        $this->middleware('web');\n-        $this->dropboxApi = $dropboxApi;\n-        $this->searchService = $searchService;\n-        $this->bitrixService = $bitrixService;\n-    }\n-\n-    public function searchAndMatch(Request $request)\n-    {\n-        $accessToken = Session::get('dropbox_access_token');\n-        \n-        if (!$accessToken) {\n-            return back()->with('error', 'يجب تسجيل الدخول أولاً');\n-        }\n-\n-        if ($request->isMethod('get')) {\n-            return view('dropbox.search-results', [\n-                'producerName' => '',\n-                'wastesLocation' => '',\n-                'matchingFiles' => [],\n-                'nonMatchingFiles' => [],\n-                'totalFiles' => 0,\n-                'allExcelFiles' => [],\n-                'sharedUrl' => $request->query('shared_url') ?? Session::get('current_shared_url'),\n-                'currentPath' => $request->query('current_path', '') ?? '',\n-            ]);\n-        }\n-\n-        $producerName = trim($request->input('producer_name', ''));\n-        $wastesLocation = trim($request->input('wastes_location', ''));\n-        $sharedUrl = $request->input('shared_url') ?? Session::get('current_shared_url');\n-        $currentPath = $request->input('current_path', '') ?? '';\n-\n-        if (empty($producerName) && empty($wastesLocation)) {\n-            return back()->with('error', 'الرجاء إدخال قيمة واحدة على الأقل للبحث');\n-        }\n-\n-        if (!$sharedUrl) {\n-            return back()->with('error', 'رابط مشارك مطلوب');\n-        }\n-\n-        try {\n-            Log::info('=== Starting Search ===');\n-\n-            $allEntries = $this->dropboxApi->getAllFilesRecursive($accessToken, $sharedUrl, $currentPath);\n-            \n-            $files = $this->searchService->categorizeFiles($allEntries);\n-            \n-            $results = $this->searchService->searchFiles(\n-                $accessToken,\n-                $sharedUrl,\n-                $files,\n-                $producerName,\n-                $wastesLocation\n-            );\n-\n-            if (count($results['matching']) > 0) {\n-                $this->bitrixService->notifySearchResults(\n-                    count($results['matching']),\n-                    $results['total'],\n-                    \"Producer: {$producerName}, Location: {$wastesLocation}\"\n-                );\n-            }\n-\n-            return view('dropbox.search-results', [\n-                'producerName' => $producerName,\n-                'wastesLocation' => $wastesLocation,\n-                'matchingFiles' => $results['matching'],\n-                'nonMatchingFiles' => $results['nonMatching'],\n-                'totalFiles' => $results['total'],\n-                'allExcelFiles' => $files['excel'],\n-                'sharedUrl' => $sharedUrl,\n-                'currentPath' => $currentPath,\n-            ]);\n-        } catch (\\Exception $e) {\n-            Log::error('Search Error: ' . $e->getMessage());\n-            return back()->with('error', 'خطأ: ' . $e->getMessage());\n-        }\n-    }\n-}\n-\n-\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766740896059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,91 +0,0 @@\n-<?php\n-namespace App\\Http\\Controllers\\Dropbox;\n-\n-use Illuminate\\Http\\Request;\n-use Illuminate\\Support\\Facades\\Log;\n-use Illuminate\\Support\\Facades\\Session;\n-use App\\Http\\Controllers\\Controller;\n-use App\\Services\\Dropbox\\DropboxApiService;\n-use App\\Services\\Excel\\ExcelProcessorService;\n-use App\\Services\\BitrixNotificationService;\n-\n-class DropboxExcelController extends Controller\n-{\n-    private DropboxApiService $dropboxApi;\n-    private ExcelProcessorService $excelProcessor;\n-    private BitrixNotificationService $bitrixService;\n-\n-    public function __construct(\n-        DropboxApiService $dropboxApi,\n-        ExcelProcessorService $excelProcessor,\n-        BitrixNotificationService $bitrixService\n-    ) {\n-        $this->middleware('web');\n-        $this->dropboxApi = $dropboxApi;\n-        $this->excelProcessor = $excelProcessor;\n-        $this->bitrixService = $bitrixService;\n-    }\n-\n-    public function processExcelUpdate(Request $request)\n-    {\n-        set_time_limit(600);\n-        ini_set('memory_limit', '512M');\n-\n-        $accessToken = Session::get('dropbox_access_token');\n-\n-        if (!$accessToken) {\n-            return back()->with('error', 'يجب تسجيل الدخول أولاً');\n-        }\n-\n-        $sharedUrl = $request->input('shared_url') ?? Session::get('current_shared_url');\n-        $matchingFiles = json_decode($request->input('matching_files'), true);\n-        $excelPath = $request->input('excel_file');\n-\n-        if (!$sharedUrl || !$excelPath || empty($matchingFiles)) {\n-            return back()->with('error', 'معلومات غير كاملة');\n-        }\n-\n-        try {\n-            Log::info('=== Starting Excel Update ===');\n-\n-            $result = $this->excelProcessor->processExcelWithPdfs(\n-                $accessToken,\n-                $sharedUrl,\n-                $excelPath,\n-                $matchingFiles\n-            );\n-\n-            if ($result['success']) {\n-                $this->bitrixService->notifyExcelProcessed(\n-                    count($matchingFiles),\n-                    $result['updatedCount'],\n-                    $excelPath\n-                );\n-\n-                return view('dropbox.process-results', [\n-                    'success' => true,\n-                    'updatedCount' => $result['updatedCount'],\n-                    'processedFiles' => $result['processedFiles'],\n-                    'newFilePath' => $excelPath,\n-                    'sharedUrl' => $sharedUrl,\n-                ]);\n-            }\n-\n-            return back()->with('error', 'فشل معالجة الملف');\n-        } catch (\\Exception $e) {\n-            Log::error('Process Excel Error: ' . $e->getMessage());\n-            return back()->with('error', 'خطأ: ' . $e->getMessage());\n-        }\n-    }\n-\n-    public function showProcessResults()\n-    {\n-        return view('dropbox.process-results', [\n-            'success' => session('success', false),\n-            'updatedCount' => session('updatedCount', 0),\n-            'processedFiles' => session('processedFiles', []),\n-            'newFilePath' => session('newFilePath', ''),\n-            'sharedUrl' => session('sharedUrl', ''),\n-        ]);\n-    }\n-}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766740913076,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1 @@\n+<?php\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766740938019,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,183 @@\n-<?php\n\\ No newline at end of file\n+<?phpnamespace App\\Services\\Dropbox;\n+\n+use Illuminate\\Support\\Facades\\Log;\n+use Smalot\\PdfParser\\Parser as PdfParser;\n+use App\\Services\\Pdf\\PdfParserService;\n+\n+class FileSearchService\n+{\n+    private DropboxApiService $dropboxApi;\n+    private PdfParserService $pdfParser;\n+\n+    public function __construct(DropboxApiService $dropboxApi, PdfParserService $pdfParser)\n+    {\n+        $this->dropboxApi = $dropboxApi;\n+        $this->pdfParser = $pdfParser;\n+    }\n+\n+    public function categorizeFiles(array $entries): array\n+    {\n+        $files = [\n+            'pdf' => [],\n+            'excel' => [],\n+            'text' => [],\n+        ];\n+\n+        foreach ($entries as $entry) {\n+            if ($entry['.tag'] !== 'file' || !isset($entry['name'])) {\n+                continue;\n+            }\n+\n+            $extension = strtolower(pathinfo($entry['name'], PATHINFO_EXTENSION));\n+            $filePath = $entry['path_display'] ?? $entry['path_lower'];\n+\n+            $fileInfo = [\n+                'name' => $entry['name'],\n+                'path' => $filePath,\n+                'size' => $entry['size'] ?? 0,\n+            ];\n+\n+            if ($extension === 'pdf') {\n+                $files['pdf'][] = $fileInfo;\n+            } elseif (in_array($extension, ['xlsx', 'xls'])) {\n+                $files['excel'][] = $fileInfo;\n+            } elseif ($this->isPreviewable($extension)) {\n+                $files['text'][] = $fileInfo;\n+            }\n+        }\n+\n+        return $files;\n+    }\n+\n+    public function searchFiles(\n+        string $accessToken,\n+        string $sharedUrl,\n+        array $files,\n+        string $producerName,\n+        string $wastesLocation\n+    ): array {\n+        $matching = [];\n+        $nonMatching = [];\n+\n+        foreach ($files['pdf'] as $file) {\n+            $result = $this->processFile($accessToken, $sharedUrl, $file, $producerName, $wastesLocation, 'pdf');\n+            if ($result['matches']) {\n+                $matching[] = $result['info'];\n+            } else {\n+                $nonMatching[] = $result['info'];\n+            }\n+        }\n+\n+        foreach ($files['text'] as $file) {\n+            $result = $this->processFile($accessToken, $sharedUrl, $file, $producerName, $wastesLocation, 'text');\n+            if ($result['matches']) {\n+                $matching[] = $result['info'];\n+            } else {\n+                $nonMatching[] = $result['info'];\n+            }\n+        }\n+\n+        return [\n+            'matching' => $matching,\n+            'nonMatching' => $nonMatching,\n+            'total' => count($files['pdf']) + count($files['text']),\n+        ];\n+    }\n+\n+    private function processFile(\n+        string $accessToken,\n+        string $sharedUrl,\n+        array $file,\n+        string $producerName,\n+        string $wastesLocation,\n+        string $type\n+    ): array {\n+        $content = $this->dropboxApi->downloadFileContent($accessToken, $sharedUrl, $file['path']);\n+\n+        if (!$content) {\n+            return [\n+                'matches' => false,\n+                'info' => array_merge($file, [\n+                    'type' => $type,\n+                    'has_producer' => false,\n+                    'has_wastes' => false,\n+                    'producer_found' => 'Failed to download',\n+                    'wastes_found' => 'Failed to download',\n+                    'missing' => ['File download failed'],\n+                ]),\n+            ];\n+        }\n+\n+        if ($type === 'pdf') {\n+            $content = $this->pdfParser->extractText($content);\n+            if (!$content) {\n+                return [\n+                    'matches' => false,\n+                    'info' => array_merge($file, [\n+                        'type' => $type,\n+                        'has_producer' => false,\n+                        'has_wastes' => false,\n+                        'missing' => ['Failed to parse PDF'],\n+                    ]),\n+                ];\n+            }\n+        }\n+\n+        $hasProducer = empty($producerName) || $this->matchesField($content, 'Producer Name', $producerName);\n+        $hasWastes = empty($wastesLocation) || $this->matchesField($content, 'Wastes Location', $wastesLocation);\n+\n+        $fileInfo = array_merge($file, [\n+            'type' => $type,\n+            'has_producer' => $hasProducer,\n+            'has_wastes' => $hasWastes,\n+            'producer_found' => $this->pdfParser->extractValue($content, 'Producer Name'),\n+            'wastes_found' => $this->pdfParser->extractValue($content, 'Wastes Location'),\n+        ]);\n+\n+        $matches = $hasProducer && $hasWastes;\n+\n+        if (!$matches) {\n+            $missing = [];\n+            if (!$hasProducer && !empty($producerName)) {\n+                $missing[] = \"Producer Name mismatch\";\n+            }\n+            if (!$hasWastes && !empty($wastesLocation)) {\n+                $missing[] = \"Wastes Location mismatch\";\n+            }\n+            $fileInfo['missing'] = $missing;\n+        }\n+\n+        return [\n+            'matches' => $matches,\n+            'info' => $fileInfo,\n+        ];\n+    }\n+\n+    private function matchesField(string $content, string $fieldName, string $searchValue): bool\n+    {\n+        if (empty($searchValue)) {\n+            return true;\n+        }\n+\n+        $extractedValue = $this->pdfParser->extractValue($content, $fieldName);\n+\n+        if ($extractedValue === 'Not Found') {\n+            return false;\n+        }\n+\n+        $extractedLower = mb_strtolower(trim($extractedValue), 'UTF-8');\n+        $searchLower = mb_strtolower(trim($searchValue), 'UTF-8');\n+\n+        return strpos($extractedLower, $searchLower) !== false;\n+    }\n+\n+    private function isPreviewable(string $extension): bool\n+    {\n+        $previewable = [\n+            'txt', 'md', 'json', 'xml', 'html', 'css', 'js',\n+            'php', 'py', 'java', 'c', 'cpp', 'h', 'yml', 'yaml',\n+            'ini', 'conf', 'log', 'sql', 'sh', 'bat',\n+        ];\n+        return in_array(strtolower($extension), $previewable);\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766740943446,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,6 @@\n-<?phpnamespace App\\Services\\Dropbox;\n+<?php\n+namespace App\\Services\\Dropbox;\n \n use Illuminate\\Support\\Facades\\Log;\n use Smalot\\PdfParser\\Parser as PdfParser;\n use App\\Services\\Pdf\\PdfParserService;\n@@ -179,5 +180,5 @@\n             'ini', 'conf', 'log', 'sql', 'sh', 'bat',\n         ];\n         return in_array(strtolower($extension), $previewable);\n     }\n-}\n\\ No newline at end of file\n+}\n"
                }
            ],
            "date": 1766740567431,
            "name": "Commit-0",
            "content": "<?php\n"
        }
    ]
}