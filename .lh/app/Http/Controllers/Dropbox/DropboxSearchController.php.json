{
    "sourceFile": "app/Http/Controllers/Dropbox/DropboxSearchController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766740572610,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766740824759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,101 @@\n-<?php\n\\ No newline at end of file\n+<?php\n+namespace App\\Http\\Controllers\\Dropbox;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Log;\n+use Illuminate\\Support\\Facades\\Session;\n+use App\\Http\\Controllers\\Controller;\n+use App\\Services\\Dropbox\\DropboxApiService;\n+use App\\Services\\Dropbox\\FileSearchService;\n+use App\\Services\\BitrixNotificationService;\n+\n+class DropboxSearchController extends Controller\n+{\n+    private DropboxApiService $dropboxApi;\n+    private FileSearchService $searchService;\n+    private BitrixNotificationService $bitrixService;\n+\n+    public function __construct(\n+        DropboxApiService $dropboxApi,\n+        FileSearchService $searchService,\n+        BitrixNotificationService $bitrixService\n+    ) {\n+        $this->middleware('web');\n+        $this->dropboxApi = $dropboxApi;\n+        $this->searchService = $searchService;\n+        $this->bitrixService = $bitrixService;\n+    }\n+\n+    public function searchAndMatch(Request $request)\n+    {\n+        $accessToken = Session::get('dropbox_access_token');\n+\n+        if (!$accessToken) {\n+            return back()->with('error', 'يجب تسجيل الدخول أولاً');\n+        }\n+\n+        if ($request->isMethod('get')) {\n+            return view('dropbox.search-results', [\n+                'producerName' => '',\n+                'wastesLocation' => '',\n+                'matchingFiles' => [],\n+                'nonMatchingFiles' => [],\n+                'totalFiles' => 0,\n+                'allExcelFiles' => [],\n+                'sharedUrl' => $request->query('shared_url') ?? Session::get('current_shared_url'),\n+                'currentPath' => $request->query('current_path', '') ?? '',\n+            ]);\n+        }\n+\n+        $producerName = trim($request->input('producer_name', ''));\n+        $wastesLocation = trim($request->input('wastes_location', ''));\n+        $sharedUrl = $request->input('shared_url') ?? Session::get('current_shared_url');\n+        $currentPath = $request->input('current_path', '') ?? '';\n+\n+        if (empty($producerName) && empty($wastesLocation)) {\n+            return back()->with('error', 'الرجاء إدخال قيمة واحدة على الأقل للبحث');\n+        }\n+\n+        if (!$sharedUrl) {\n+            return back()->with('error', 'رابط مشارك مطلوب');\n+        }\n+\n+        try {\n+            Log::info('=== Starting Search ===');\n+\n+            $allEntries = $this->dropboxApi->getAllFilesRecursive($accessToken, $sharedUrl, $currentPath);\n+\n+            $files = $this->searchService->categorizeFiles($allEntries);\n+\n+            $results = $this->searchService->searchFiles(\n+                $accessToken,\n+                $sharedUrl,\n+                $files,\n+                $producerName,\n+                $wastesLocation\n+            );\n+\n+            if (count($results['matching']) > 0) {\n+                $this->bitrixService->notifySearchResults(\n+                    count($results['matching']),\n+                    $results['total'],\n+                    \"Producer: {$producerName}, Location: {$wastesLocation}\"\n+                );\n+            }\n+\n+            return view('dropbox.search-results', [\n+                'producerName' => $producerName,\n+                'wastesLocation' => $wastesLocation,\n+                'matchingFiles' => $results['matching'],\n+                'nonMatchingFiles' => $results['nonMatching'],\n+                'totalFiles' => $results['total'],\n+                'allExcelFiles' => $files['excel'],\n+                'sharedUrl' => $sharedUrl,\n+                'currentPath' => $currentPath,\n+            ]);\n+        } catch (\\Exception $e) {\n+            Log::error('Search Error: ' . $e->getMessage());\n+            return back()->with('error', 'خطأ: ' . $e->getMessage());\n+        }\n+    }\n+}\n"
                }
            ],
            "date": 1766740572610,
            "name": "Commit-0",
            "content": "<?php"
        }
    ]
}