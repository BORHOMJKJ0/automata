{
    "sourceFile": "app/Http/Controllers/DropboxController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1764385686694,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764385695737,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,63 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Storage;\n+\n+class DropboxController extends Controller\n+{\n+    // عرض الصفحة الرئيسية\n+    public function index()\n+    {\n+        return $this->browse('');\n+    }\n+\n+    // تصفح مجلد معين\n+    public function browse($path = '')\n+    {\n+        try {\n+            $contents = Storage::disk('dropbox')->listContents($path);\n+\n+            $items = [\n+                'folders' => [],\n+                'files' => []\n+            ];\n+\n+            foreach ($contents as $item) {\n+                if ($item->isDir()) {\n+                    $items['folders'][] = [\n+                        'name' => $item->path(),\n+                        'path' => $item->path(),\n+                    ];\n+                } else {\n+                    $items['files'][] = [\n+                        'name' => basename($item->path()),\n+                        'path' => $item->path(),\n+                        'size' => $item->fileSize(),\n+                        'modified' => $item->lastModified(),\n+                    ];\n+                }\n+            }\n+\n+            return view('dropbox.browse', [\n+                'items' => $items,\n+                'currentPath' => $path\n+            ]);\n+\n+        } catch (\\Exception $e) {\n+            return back()->with('error', 'خطأ في قراءة الملفات: ' . $e->getMessage());\n+        }\n+    }\n+\n+    // تحميل ملف\n+    public function download($path)\n+    {\n+        try {\n+            $filename = basename($path);\n+            return Storage::disk('dropbox')->download($path, $filename);\n+        } catch (\\Exception $e) {\n+            return back()->with('error', 'خطأ في تحميل الملف');\n+        }\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1764385841155,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,62 +2,160 @@\n \n namespace App\\Http\\Controllers;\n \n use Illuminate\\Http\\Request;\n-use Illuminate\\Support\\Facades\\Storage;\n+use Illuminate\\Support\\Facades\\Http;\n \n class DropboxController extends Controller\n {\n-    // عرض الصفحة الرئيسية\n+    private $accessToken;\n+\n+    public function __construct()\n+    {\n+        $this->accessToken = env('DROPBOX_ACCESS_TOKEN');\n+    }\n+\n+    // صفحة إدخال الرابط\n     public function index()\n     {\n-        return $this->browse('');\n+        return view('dropbox.index');\n     }\n \n-    // تصفح مجلد معين\n-    public function browse($path = '')\n+    // معالجة الرابط وعرض المحتوى\n+    public function browse(Request $request)\n     {\n+        $request->validate([\n+            'dropbox_url' => 'required|url'\n+        ]);\n+\n+        $url = $request->dropbox_url;\n+\n+        // استخراج shared_link من الرابط\n+        $sharedLink = $this->normalizeDropboxUrl($url);\n+\n         try {\n-            $contents = Storage::disk('dropbox')->listContents($path);\n+            // استدعاء Dropbox API\n+            $response = Http::withHeaders([\n+                'Authorization' => 'Bearer ' . $this->accessToken,\n+                'Content-Type' => 'application/json',\n+            ])->post('https://api.dropboxapi.com/2/files/list_folder', [\n+                'shared_link' => [\n+                    'url' => $sharedLink\n+                ],\n+                'path' => ''\n+            ]);\n \n-            $items = [\n-                'folders' => [],\n-                'files' => []\n-            ];\n+            if ($response->failed()) {\n+                return back()->with('error', 'فشل الوصول للرابط. تأكد من صلاحيات المشاركة.');\n+            }\n \n-            foreach ($contents as $item) {\n-                if ($item->isDir()) {\n-                    $items['folders'][] = [\n-                        'name' => $item->path(),\n-                        'path' => $item->path(),\n-                    ];\n-                } else {\n-                    $items['files'][] = [\n-                        'name' => basename($item->path()),\n-                        'path' => $item->path(),\n-                        'size' => $item->fileSize(),\n-                        'modified' => $item->lastModified(),\n-                    ];\n-                }\n+            $data = $response->json();\n+            $items = $this->organizeItems($data['entries']);\n+\n+            return view('dropbox.browse', [\n+                'items' => $items,\n+                'sharedLink' => $sharedLink\n+            ]);\n+\n+        } catch (\\Exception $e) {\n+            return back()->with('error', 'خطأ: ' . $e->getMessage());\n+        }\n+    }\n+\n+    // تنظيم الملفات والمجلدات\n+    private function organizeItems($entries)\n+    {\n+        $items = [\n+            'folders' => [],\n+            'files' => []\n+        ];\n+\n+        foreach ($entries as $entry) {\n+            if ($entry['.tag'] === 'folder') {\n+                $items['folders'][] = [\n+                    'name' => $entry['name'],\n+                    'path' => $entry['path_display'],\n+                    'id' => $entry['id'] ?? null\n+                ];\n+            } else {\n+                $items['files'][] = [\n+                    'name' => $entry['name'],\n+                    'path' => $entry['path_display'],\n+                    'size' => $entry['size'] ?? 0,\n+                    'modified' => $entry['client_modified'] ?? null,\n+                    'id' => $entry['id'] ?? null\n+                ];\n             }\n+        }\n \n+        return $items;\n+    }\n+\n+    // تطبيع رابط Dropbox\n+    private function normalizeDropboxUrl($url)\n+    {\n+        // تحويل dl=0 إلى dl=1 للتحميل المباشر\n+        $url = str_replace('dl=0', 'dl=1', $url);\n+\n+        // إزالة المعاملات الزائدة إذا لزم الأمر\n+        return $url;\n+    }\n+\n+    // تصفح مجلد فرعي\n+    public function browseSubfolder(Request $request)\n+    {\n+        $sharedLink = $request->shared_link;\n+        $path = $request->path ?? '';\n+\n+        try {\n+            $response = Http::withHeaders([\n+                'Authorization' => 'Bearer ' . $this->accessToken,\n+                'Content-Type' => 'application/json',\n+            ])->post('https://api.dropboxapi.com/2/files/list_folder', [\n+                'shared_link' => [\n+                    'url' => $sharedLink\n+                ],\n+                'path' => $path\n+            ]);\n+\n+            $data = $response->json();\n+            $items = $this->organizeItems($data['entries']);\n+\n             return view('dropbox.browse', [\n                 'items' => $items,\n+                'sharedLink' => $sharedLink,\n                 'currentPath' => $path\n             ]);\n \n         } catch (\\Exception $e) {\n-            return back()->with('error', 'خطأ في قراءة الملفات: ' . $e->getMessage());\n+            return back()->with('error', 'خطأ: ' . $e->getMessage());\n         }\n     }\n \n     // تحميل ملف\n-    public function download($path)\n+    public function downloadFile(Request $request)\n     {\n+        $sharedLink = $request->shared_link;\n+        $path = $request->path;\n+\n         try {\n+            $response = Http::withHeaders([\n+                'Authorization' => 'Bearer ' . $this->accessToken,\n+                'Dropbox-API-Arg' => json_encode([\n+                    'shared_link' => [\n+                        'url' => $sharedLink\n+                    ],\n+                    'path' => $path\n+                ])\n+            ])->get('https://content.dropboxapi.com/2/files/download');\n+\n             $filename = basename($path);\n-            return Storage::disk('dropbox')->download($path, $filename);\n+\n+            return response($response->body())\n+                ->header('Content-Type', $response->header('Content-Type'))\n+                ->header('Content-Disposition', 'attachment; filename=\"' . $filename . '\"');\n+\n         } catch (\\Exception $e) {\n-            return back()->with('error', 'خطأ في تحميل الملف');\n+            return back()->with('error', 'فشل التحميل');\n         }\n     }\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1764386267985,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,146 +13,237 @@\n     {\n         $this->accessToken = env('DROPBOX_ACCESS_TOKEN');\n     }\n \n-    // صفحة إدخال الرابط\n+    /**\n+     * الصفحة الرئيسية - إدخال الرابط\n+     */\n     public function index()\n     {\n         return view('dropbox.index');\n     }\n \n-    // معالجة الرابط وعرض المحتوى\n+    /**\n+     * معالجة رابط المشاركة وعرض المحتوى\n+     */\n     public function browse(Request $request)\n     {\n         $request->validate([\n             'dropbox_url' => 'required|url'\n         ]);\n \n-        $url = $request->dropbox_url;\n+        $sharedUrl = $this->normalizeUrl($request->dropbox_url);\n+        $path = $request->get('path', '');\n \n-        // استخراج shared_link من الرابط\n-        $sharedLink = $this->normalizeDropboxUrl($url);\n-\n         try {\n-            // استدعاء Dropbox API\n+            // استدعاء API لقراءة محتوى المجلد المشارك\n             $response = Http::withHeaders([\n                 'Authorization' => 'Bearer ' . $this->accessToken,\n                 'Content-Type' => 'application/json',\n             ])->post('https://api.dropboxapi.com/2/files/list_folder', [\n+                'path' => $path,\n                 'shared_link' => [\n-                    'url' => $sharedLink\n-                ],\n-                'path' => ''\n+                    'url' => $sharedUrl\n+                ]\n             ]);\n \n             if ($response->failed()) {\n-                return back()->with('error', 'فشل الوصول للرابط. تأكد من صلاحيات المشاركة.');\n+                $error = $response->json();\n+                return back()->with('error', 'خطأ: ' . ($error['error_summary'] ?? 'فشل الوصول للرابط'));\n             }\n \n             $data = $response->json();\n             $items = $this->organizeItems($data['entries']);\n \n             return view('dropbox.browse', [\n                 'items' => $items,\n-                'sharedLink' => $sharedLink\n+                'sharedUrl' => $sharedUrl,\n+                'currentPath' => $path,\n+                'hasMore' => $data['has_more'] ?? false\n             ]);\n+\n         } catch (\\Exception $e) {\n             return back()->with('error', 'خطأ: ' . $e->getMessage());\n         }\n     }\n \n-    // تنظيم الملفات والمجلدات\n-    private function organizeItems($entries)\n+    /**\n+     * تصفح مجلد فرعي\n+     */\n+    public function browseFolder(Request $request)\n     {\n-        $items = [\n-            'folders' => [],\n-            'files' => []\n-        ];\n+        $sharedUrl = $request->get('shared_url');\n+        $path = $request->get('path', '');\n \n-        foreach ($entries as $entry) {\n-            if ($entry['.tag'] === 'folder') {\n-                $items['folders'][] = [\n-                    'name' => $entry['name'],\n-                    'path' => $entry['path_display'],\n-                    'id' => $entry['id'] ?? null\n-                ];\n-            } else {\n-                $items['files'][] = [\n-                    'name' => $entry['name'],\n-                    'path' => $entry['path_display'],\n-                    'size' => $entry['size'] ?? 0,\n-                    'modified' => $entry['client_modified'] ?? null,\n-                    'id' => $entry['id'] ?? null\n-                ];\n-            }\n+        if (!$sharedUrl) {\n+            return back()->with('error', 'رابط المشاركة مفقود');\n         }\n \n-        return $items;\n-    }\n-\n-    // تطبيع رابط Dropbox\n-    private function normalizeDropboxUrl($url)\n-    {\n-        // تحويل dl=0 إلى dl=1 للتحميل المباشر\n-        $url = str_replace('dl=0', 'dl=1', $url);\n-\n-        // إزالة المعاملات الزائدة إذا لزم الأمر\n-        return $url;\n-    }\n-\n-    // تصفح مجلد فرعي\n-    public function browseSubfolder(Request $request)\n-    {\n-        $sharedLink = $request->shared_link;\n-        $path = $request->path ?? '';\n-\n         try {\n             $response = Http::withHeaders([\n                 'Authorization' => 'Bearer ' . $this->accessToken,\n                 'Content-Type' => 'application/json',\n             ])->post('https://api.dropboxapi.com/2/files/list_folder', [\n+                'path' => $path,\n                 'shared_link' => [\n-                    'url' => $sharedLink\n-                ],\n-                'path' => $path\n+                    'url' => $sharedUrl\n+                ]\n             ]);\n \n+            if ($response->failed()) {\n+                return back()->with('error', 'فشل الوصول للمجلد');\n+            }\n+\n             $data = $response->json();\n             $items = $this->organizeItems($data['entries']);\n \n             return view('dropbox.browse', [\n                 'items' => $items,\n-                'sharedLink' => $sharedLink,\n-                'currentPath' => $path\n+                'sharedUrl' => $sharedUrl,\n+                'currentPath' => $path,\n+                'hasMore' => $data['has_more'] ?? false\n             ]);\n+\n         } catch (\\Exception $e) {\n             return back()->with('error', 'خطأ: ' . $e->getMessage());\n         }\n     }\n \n-    // تحميل ملف\n-    public function downloadFile(Request $request)\n+    /**\n+     * تحميل ملف\n+     */\n+    public function download(Request $request)\n     {\n-        $sharedLink = $request->shared_link;\n-        $path = $request->path;\n+        $sharedUrl = $request->get('shared_url');\n+        $path = $request->get('path');\n \n+        if (!$sharedUrl || !$path) {\n+            return back()->with('error', 'معلومات الملف ناقصة');\n+        }\n+\n         try {\n+            // استخدام API لتحميل الملف من الرابط المشارك\n             $response = Http::withHeaders([\n                 'Authorization' => 'Bearer ' . $this->accessToken,\n                 'Dropbox-API-Arg' => json_encode([\n+                    'path' => $path,\n                     'shared_link' => [\n-                        'url' => $sharedLink\n-                    ],\n-                    'path' => $path\n+                        'url' => $sharedUrl\n+                    ]\n                 ])\n             ])->get('https://content.dropboxapi.com/2/files/download');\n \n+            if ($response->failed()) {\n+                return back()->with('error', 'فشل تحميل الملف');\n+            }\n+\n+            // استخراج اسم الملف\n             $filename = basename($path);\n \n+            // إرجاع الملف للتحميل\n             return response($response->body())\n-                ->header('Content-Type', $response->header('Content-Type'))\n+                ->header('Content-Type', $response->header('Content-Type') ?? 'application/octet-stream')\n                 ->header('Content-Disposition', 'attachment; filename=\"' . $filename . '\"');\n+\n         } catch (\\Exception $e) {\n-            return back()->with('error', 'فشل التحميل');\n+            return back()->with('error', 'خطأ في التحميل: ' . $e->getMessage());\n         }\n     }\n-}\n+\n+    /**\n+     * معاينة الملف (للصور والـ PDFs)\n+     */\n+    public function preview(Request $request)\n+    {\n+        $sharedUrl = $request->get('shared_url');\n+        $path = $request->get('path');\n+\n+        if (!$sharedUrl || !$path) {\n+            return back()->with('error', 'معلومات الملف ناقصة');\n+        }\n+\n+        try {\n+            $response = Http::withHeaders([\n+                'Authorization' => 'Bearer ' . $this->accessToken,\n+                'Dropbox-API-Arg' => json_encode([\n+                    'path' => $path,\n+                    'shared_link' => [\n+                        'url' => $sharedUrl\n+                    ]\n+                ])\n+            ])->get('https://content.dropboxapi.com/2/files/download');\n+\n+            if ($response->failed()) {\n+                return back()->with('error', 'فشل تحميل الملف');\n+            }\n+\n+            $contentType = $response->header('Content-Type') ?? 'application/octet-stream';\n+\n+            return response($response->body())\n+                ->header('Content-Type', $contentType);\n+\n+        } catch (\\Exception $e) {\n+            return back()->with('error', 'خطأ في المعاينة: ' . $e->getMessage());\n+        }\n+    }\n+\n+    /**\n+     * تنظيم الملفات والمجلدات\n+     */\n+    private function organizeItems($entries)\n+    {\n+        $items = [\n+            'folders' => [],\n+            'files' => []\n+        ];\n+\n+        foreach ($entries as $entry) {\n+            if ($entry['.tag'] === 'folder') {\n+                $items['folders'][] = [\n+                    'name' => $entry['name'],\n+                    'path' => $entry['path_display'] ?? $entry['path_lower'],\n+                    'id' => $entry['id'] ?? null\n+                ];\n+            } else {\n+                $extension = pathinfo($entry['name'], PATHINFO_EXTENSION);\n+\n+                $items['files'][] = [\n+                    'name' => $entry['name'],\n+                    'path' => $entry['path_display'] ?? $entry['path_lower'],\n+                    'size' => $entry['size'] ?? 0,\n+                    'modified' => $entry['server_modified'] ?? $entry['client_modified'] ?? null,\n+                    'id' => $entry['id'] ?? null,\n+                    'extension' => strtolower($extension),\n+                    'is_previewable' => $this->isPreviewable($extension)\n+                ];\n+            }\n+        }\n+\n+        return $items;\n+    }\n+\n+    /**\n+     * تحقق إذا الملف قابل للمعاينة\n+     */\n+    private function isPreviewable($extension)\n+    {\n+        $previewable = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf', 'txt', 'md'];\n+        return in_array(strtolower($extension), $previewable);\n+    }\n+\n+    /**\n+     * تطبيع رابط Dropbox\n+     */\n+    private function normalizeUrl($url)\n+    {\n+        // التأكد من أن dl=0 (للمعاينة) وليس dl=1 (تحميل مباشر)\n+        $url = str_replace('dl=1', 'dl=0', $url);\n+\n+        // إذا لم يكن فيه dl parameter، أضفه\n+        if (strpos($url, 'dl=') === false) {\n+            $separator = strpos($url, '?') !== false ? '&' : '?';\n+            $url .= $separator . 'dl=0';\n+        }\n+\n+        return $url;\n+    }\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1764385686694,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Http\\Controllers;\n\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\Storage;\n\nclass DropboxController extends Controller\n{\n    // عرض الصفحة الرئيسية\n    public function index()\n    {\n        return $this->browse('');\n    }\n\n    // تصفح مجلد معين\n    public function browse($path = '')\n    {\n        try {\n            $contents = Storage::disk('dropbox')->listContents($path);\n\n            $items = [\n                'folders' => [],\n                'files' => []\n            ];\n\n            foreach ($contents as $item) {\n                if ($item->isDir()) {\n                    $items['folders'][] = [\n                        'name' => $item->path(),\n                        'path' => $item->path(),\n                    ];\n                } else {\n                    $items['files'][] = [\n                        'name' => basename($item->path()),\n                        'path' => $item->path(),\n                        'size' => $item->fileSize(),\n                        'modified' => $item->lastModified(),\n                    ];\n                }\n            }\n\n            return view('dropbox.browse', [\n                'items' => $items,\n                'currentPath' => $path\n            ]);\n\n        } catch (\\Exception $e) {\n            return back()->with('error', 'خطأ في قراءة الملفات: ' . $e->getMessage());\n        }\n    }\n\n    // تحميل ملف\n    public function download($path)\n    {\n        try {\n            $filename = basename($path);\n            return Storage::disk('dropbox')->download($path, $filename);\n        } catch (\\Exception $e) {\n            return back()->with('error', 'خطأ في تحميل الملف');\n        }\n    }\n}\n```\n\n---\n\n### 5. **Views (الواجهات)**\n```\nresources/\n└── views/\n    └── dropbox/\n        ├── layout.blade.php         # القالب الأساسي\n        └── browse.blade.php         # صفحة التصفح"
        }
    ]
}